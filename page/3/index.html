<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.119.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Jamie Magee &#183; Jamie Magee</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=font><link rel=preload href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2')}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link href=/favicon.ico rel=icon><link rel=alternate type=application/rss+xml href=/index.xml title="Jamie Magee"><meta name=description content><meta name=keywords content><meta property="og:title" content="Jamie Magee"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jamie Magee"><meta name=twitter:description content></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa fa-github-square fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa fa-linkedin-square fa-3x"></i></a>
<a href=http://twitter.com/Jamie_Magee><i class="fa fa-twitter-square fa-3x"></i></a></li></ul><p>&copy; 2023. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=/blog/common-async-pitfalls-part-one/>Common async pitfalls—part one</a></h1><span class=post-date>Nov 17, 2020 &#183; 8 minute read &#183; <a href=/blog/common-async-pitfalls-part-one/#disqus_thread>Comments</a></span><p>The .NET Framework provides a great programming model that enables high performance code using an easy to understand syntax. However, this can often give developers a false sense of security, and the language and runtime aren&rsquo;t without pitfalls. Ideally static analysers, like the <a href=https://www.nuget.org/packages/Microsoft.VisualStudio.Threading.Analyzers/>Microsoft.VisualStudio.Threading.Analyzers Roslyn analysers</a>, would catch all these issues at build time. While they do help catch a lot of mistakes, they can&rsquo;t catch everything, so it&rsquo;s important to understand the problems and how to avoid them.</p><p>Here&rsquo;s a collection of some of the most common pitfalls I&rsquo;ve come across—either myself, colleagues and friends, or examples in documentation—and how to avoid them.</p><h2 id=blocking-calls>Blocking calls</h2><p>The main benefit of asynchronous programming is that the thread pool can be smaller than a synchronous application while performing the same amount of work. However, once a piece of code begins to block threads, the resulting thread pool starvation can be ugly.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task DoStuffAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Task&lt;<span style=color:#458;font-weight:700>bool</span>&gt; resultTask = StuffAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#998;font-style:italic>// BAD: These may deadlock depending on thread pool capacity or the presence of a sync context</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    resultTask.Wait();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    resultTask.Result;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    resultTask.GetAwaiter().GetResult();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#998;font-style:italic>// BAD: This blocks the thread</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    Thread.Sleep(<span style=color:#099>5000</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#998;font-style:italic>// GOOD: Always await</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#000;font-weight:700>await</span> resultTask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#998;font-style:italic>// GOOD: This does not block and allows for maximum throughput</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>await</span> Task.Delay(<span style=color:#099>5000</span>, cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><p>If I run a small test, which makes 5000 concurrent HTTP requests to a local server, there are dramatically different results depending on how many blocking calls are used.</p><p>% blocking shows the number of calls that use <code>Task.Result</code>, which blocks the thread. All other requests use <code>await</code>.</p><table><thead><tr><th>% Blocking</th><th>Threads</th><th>Total Duration</th><th>Avg. Duration</th></tr></thead><tbody><tr><td>0</td><td>24</td><td>00:00:11.961</td><td>0.0023923</td></tr><tr><td>5</td><td>268</td><td>00:02:16.574</td><td>0.0273148</td></tr></tbody></table><p>The increased total duration when using blocking calls is due to the thread pool growth, which happens slowly. You can always tune the thread pool settings to achieve better performance, but it will never match the performance you can achieve with non-blocking calls.</p><h3 id=streams>Streams</h3><p>Like all other blocking calls, any methods from <code>System.IO.Stream</code> should use their async equivalents: <code>Read</code> to <code>ReadAsync</code>, <code>Write</code> to <code>WriteAsync</code>, <code>Flush</code> to <code>FlushAsync</code>, etc. Also, after writing to a stream, you should call the <code>FlushAsync</code> method before disposing the stream. If not, the <code>Dispose</code> method may perform some blocking calls.</p><h2 id=cancellationtoken>CancellationToken</h2><p>You should always propagate cancellation tokens to the next caller in the chain. This is called a cooperative cancellation model. If not, you can end up with methods that run longer than expected, or even worse, never complete.</p><p>To indicate to the caller that cancellation is supported, the final parameter in the method signature should be a <code>CancellationToken</code> object.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task DoStuffAsync()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#998;font-style:italic>// BAD: This method does not accept a cancellation token. Cooperative cancellation is extremely important.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#000;font-weight:700>await</span> StuffAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task DoStuffAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#458;font-weight:700>var</span> httpClient = <span style=color:#000;font-weight:700>new</span> HttpClient();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#998;font-style:italic>// BAD: The caller has provided a cancellation token for cooperative cancellation but it was not provided</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#998;font-style:italic>// downstream. Regardless of the token being signaled the http client will not return until the</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#998;font-style:italic>// operation completes.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#000;font-weight:700>await</span> httpClient.GetAsync(<span style=color:#d14>&#34;http://example.com&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#998;font-style:italic>// GOOD: Always propagate the token to the next caller in the chain</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>await</span> httpClient.GetAsync(<span style=color:#d14>&#34;http://example.com&#34;</span>, cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><h3 id=linked-tokens>Linked tokens</h3><p>If you need to put a timeout on an inner method call, you can link one cancellation token to another. For example, you want to make a service-to-service call, and you want to enforce a timeout, while still respecting the external cancellation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task&lt;<span style=color:#458;font-weight:700>int</span>&gt; DoThingAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>using</span> (<span style=color:#458;font-weight:700>var</span> cancelTokenSource = CancellationTokenSource.CreateLinkedTokenSource(cancellationToken))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        <span style=color:#998;font-style:italic>// The cancellation token source will now manage a timer which automatically notifies the parent</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#998;font-style:italic>// token.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        cancelTokenSource.CancelAfter(TimeSpan.FromSeconds(<span style=color:#099>10</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#998;font-style:italic>// By linking the token source we will now cooperatively cancel. We have also</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>		<span style=color:#998;font-style:italic>// provided a time based auto-cancellation signal which only applies to the </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>		<span style=color:#998;font-style:italic>// the single method. This is how nested cancellation scopes may be used in circuit breakers.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>await</span> GetAsync(cancelTokenSource.Token);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#998;font-style:italic>// Other calls within the method may not need this restricted timeout so the original</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#998;font-style:italic>// cancellation token is used instead.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>await</span> DoOtherThingAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span></code></pre></div><h3 id=cancelling-uncancellable-operations>Cancelling uncancellable operations</h3><p>Sometimes you may find the need to call an API which does not accept a cancellation token, but your API receives a token and is expected to respect cancellation. In this case the typical pattern involves managing two tasks and effectively abandoning the un-cancellable operation after the token signals.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task&lt;<span style=color:#458;font-weight:700>int</span>&gt; DoThingAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#458;font-weight:700>var</span> tcs = <span style=color:#000;font-weight:700>new</span> TaskCompetionSource&lt;<span style=color:#458;font-weight:700>int</span>&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#000;font-weight:700>using</span> (<span style=color:#458;font-weight:700>var</span> registration = cancellationToken.Register(() =&gt; tcs.SetResult(<span style=color:#099>0</span>)))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>         <span style=color:#458;font-weight:700>var</span> completedTask = <span style=color:#000;font-weight:700>await</span> Task.WhenAny(tcs.Task, DoNonCancellableCallAsync());
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>         <span style=color:#000;font-weight:700>if</span> (completedTask == tcs.Task)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>         {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>             <span style=color:#998;font-style:italic>// We have been cancelled, so take appropriate action here. At this point in time the non-cancellable call is</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>             <span style=color:#998;font-style:italic>// still running. Once it completes everything will be properly garbage collected</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>             <span style=color:#000;font-weight:700>throw</span> <span style=color:#000;font-weight:700>new</span> OperationCanceledException(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>         }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>await</span> completedTask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><h2 id=constructors>Constructors</h2><p>Occasionally, you may find yourself wanting to perform asynchronous work during initialization of a class instance. Unfortunately, there is no way to make constructors async.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Foo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>public</span> Foo(<span style=color:#458;font-weight:700>int</span> a, <span style=color:#458;font-weight:700>int</span> c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        _a = a;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#998;font-style:italic>// DON&#39;T DO THIS!</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        _b = CallSomethingAsync().SyncResult();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        _c = c;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>readonly</span> <span style=color:#458;font-weight:700>int</span> _a;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>readonly</span> <span style=color:#458;font-weight:700>string</span> _b;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>readonly</span> <span style=color:#458;font-weight:700>int</span> _c;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>}
</span></span></code></pre></div><p>There are a couple of different ways to solve this. Here&rsquo;s a pattern I like:</p><ol><li>A public static creator method, which publicly replaces the constructor</li><li>A private async member method, which does the work the constructor used to do</li><li>A private constructor, so callers can&rsquo;t directly instantiate the class by mistake</li></ol><p>So, if I apply the same pattern to the class above the class becomes:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Foo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>static</span> <span style=color:#000;font-weight:700>async</span> Task&lt;Foo&gt; CreateAsync(<span style=color:#458;font-weight:700>int</span> a, <span style=color:#458;font-weight:700>int</span> c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        Foo instance = <span style=color:#000;font-weight:700>new</span> Foo(a, c);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#000;font-weight:700>await</span> instance.InitializeAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#000;font-weight:700>return</span> instance;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>private</span> Foo(<span style=color:#458;font-weight:700>int</span> a, <span style=color:#458;font-weight:700>int</span> c)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#998;font-style:italic>// GOOD: readonly keyword is retained</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        _a = a;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        _c = c;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>async</span> Task InitializeAsync()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#998;font-style:italic>// GOOD: all async work is performed here</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#998;font-style:italic>// NOTE: make sure initialization order is correct when porting existing code</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        _b = <span style=color:#000;font-weight:700>await</span> CallSomethingAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>readonly</span> <span style=color:#458;font-weight:700>int</span> _a;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    <span style=color:#000;font-weight:700>private</span> <span style=color:#000;font-weight:700>readonly</span> <span style=color:#458;font-weight:700>int</span> _c;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    <span style=color:#458;font-weight:700>string</span> _b;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>}
</span></span></code></pre></div><p>And we can instantiate the class by calling <code>var foo = await Foo.CreateAsync(1, 2);</code>.</p><p>In cases where the class is part of an inheritance hierarchy, the constructor can be made protected and <code>InitializeAsync</code> can be made protected virtual, so it can be overridden and called from derived classes. Each derived class will need to have its own <code>CreateAsync</code> method.</p><h2 id=parallelism>Parallelism</h2><h3 id=avoid-premature-optimization>Avoid premature optimization</h3><p>It might be very tempting to try to perform parallel work by not immediately awaiting tasks. In some cases, you can make significant performance improvements. However, if not used with care you can end up in debugging hell involving socket or port exhaustion, or database connection pool saturation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task DoTwoThingsAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#998;font-style:italic>// Depending on what you are doing under the covers, this may cause unintended</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#998;font-style:italic>// consequences such as exhaustion of outgoing sockets or database connections.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#458;font-weight:700>var</span> thing1Task = FirstAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#458;font-weight:700>var</span> thing2Task = SecondAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#000;font-weight:700>await</span> Task.WhenAll(thing1Task, thing2Task);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#998;font-style:italic>// Prefer sequential execution of asynchronous calls</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>await</span> FirstAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>await</span> SecondAsync(cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p>Using async everywhere generally pays off without having to make any individual piece of code faster via parallelization. When threads aren&rsquo;t blocking you can achieve higher performance with the same amount of CPU.</p><h3 id=avoid-taskfactorystartnew-and-use-taskrun-only-when-needed>Avoid Task.Factory.StartNew, and use Task.Run only when needed</h3><p>Even in the cases where not immediately awaiting is safe, you should avoid <code>Task.Factory.StartNew</code>, and only use <code>Task.Run</code> when you need to run some CPU-bound code asynchronously.</p><p>The main way <code>Task.Factory.StartNew</code> is dangerous is that it can look like tasks are awaited when they aren&rsquo;t. For example, if you <code>async</code>-ify the following code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Task.WhenAll(Task.Factory.StartNew(Foo), Task.Factory.StartNew(Foo2)).Wait();
</span></span></code></pre></div><p>be careful because changing the delegate to one that returns <code>Task</code>, <code>Task.Factory.StartNew</code> will now return <code>Task&lt;Task></code>. Awaiting only the outer task will only wait until the actual task starts, not finishes.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#998;font-style:italic>// BAD: Only waits until all tasks have been scheduled, not until the actual work has completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#000;font-weight:700>await</span> Task.WhenAll(Task.Factory.StartNew(FooAsync), Task.Factory.StartNew(Foo2Async));
</span></span></code></pre></div><p>Normally what you want to do, when you know delegates are not CPU-bound, is to just use the delegates themselves. This is almost always the right thing to do.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#998;font-style:italic>// GOOD: Will wait until the tasks have all completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#000;font-weight:700>await</span> Task.WhenAll(FooAsync(), Foo2Async());
</span></span></code></pre></div><p>However, if you are certain the delegates are CPU-bound, and you want to offload this to the thread pool, you can use <code>Task.Run</code>. It&rsquo;s designed to support async delegates. I&rsquo;d still recommend reading <a href=https://blog.stephencleary.com/2013/10/taskrun-etiquette-and-proper-usage.html>Task.Run Etiquette and Proper Usage</a> for a more thorough explanation.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#998;font-style:italic>// Ok if FooAsync is known to be primarily CPU-bound (especially before going async).</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#998;font-style:italic>// Will schedule the CPU-bound work like Task.Factory.StartNew does,</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#998;font-style:italic>// and automatically convert Task&lt;Task&gt; into a &#39;proxy&#39; Task that represents the actual work</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#000;font-weight:700>await</span> Task.WhenAll(Task.Run(FooAsync), Task.Run(Foo2Async))
</span></span></code></pre></div><p>If, for some extremely unlikely reason, you really do need to use <code>Task.Factory.StartNew</code> you can use <code>Unwrap()</code> or <code>await await</code> to convert a <code>Task&lt;Task></code> into a <code>Task</code> that represents the actual work. I&rsquo;d recommend reading <a href=https://devblogs.microsoft.com/pfxteam/task-run-vs-task-factory-startnew/>Task.Run vs Task.Factory.StartNew</a> for a deeper dive into the topic.</p><h2 id=null-conditionals>Null conditionals</h2><p>Using the null conditional operator with awaitables can be dangerous. Awaiting null throws a <code>NullReferenceException</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#998;font-style:italic>// BAD: Will throw NullReferenceException if foo is null</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#000;font-weight:700>await</span> foo?.DoStuffAsync()
</span></span></code></pre></div><p>Instead, you must do a manual check first.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#998;font-style:italic>// GOOD</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#000;font-weight:700>if</span> (foo != <span style=color:#000;font-weight:700>null</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#000;font-weight:700>await</span> foo.DoStuffAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p>A <a href=https://github.com/dotnet/csharplang/issues/35>Null-conditional await</a> is currently under consideration for future versions of C#, but until then you&rsquo;re stuck with manually checking.</p></div><div class=post><h1 class=post-title><a href=/blog/zwift-on-linux/>Zwift on Linux</a></h1><span class=post-date>Apr 7, 2020 &#183; 2 minute read &#183; <a href=/blog/zwift-on-linux/#disqus_thread>Comments</a></span><p>Getting Zwift to run on Linux was a journey I started <a href="https://bugs.winehq.org/show_bug.cgi?id=46313">just over a year ago</a>. I didn&rsquo;t get very far with my effort, but since then a lot of progress has been made by the Wine developers and others in the community, and Zwift is now (mostly) playable on Linux. I&rsquo;ll admit there are some workarounds required. Like having to use the <a href=https://support.zwift.com/en_us/using-the-zwift-companion-app-Hybn8qzPr>Zwift companion app</a> to connect sensors. But on the whole, it works well. So I wanted to summarise the process for anyone who wants to try it for themselves.</p><p>I&rsquo;m using <a href=https://lutris.net/>Lutris</a>, a gaming client for Linux, to script out all the steps needed to make games playable on Linux. If you&rsquo;ve never used it before, I&rsquo;d really recommend it for gaming on Linux in general. First things first, you&rsquo;re going to have to download and install Lutris for your Linux distribution. Thankfully Lutris has a great <a href=https://lutris.net/downloads/>help page</a> explaining how to do this for most distributions.</p><h2 id=installation>Installation</h2><p>Once you&rsquo;ve got Lutris installed, installing Zwift is pretty easy. In Lutris search for Zwift, select the only result, and click the “Install” button to start the installation process. You can also start the installer from the command line by running <code>lutris install/zwift-windows</code>.</p><p><img src=/img/ZoL.png alt="Lutris Installer"></p><p>This might take a while, and depending on your internet speed could be anywhere from 10 minutes to around an hour.</p><p>Once the Zwift launcher has finished downloading and updating, we&rsquo;ve hit the first hurdle that can&rsquo;t be scripted with Lutris.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/punu7GdyrsE style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div><p>The launcher will appear as a blank white window. Actually, the launcher is displaying a web page, but Wine can&rsquo;t render properly. Thankfully all the files are already downloaded, so all you need to do is quit the launcher window, and exit Zwift from the Wine system menu. After that, the Lutris installer should complete.</p><h2 id=running-zwift>Running Zwift</h2><p>Zwift requires the Launcher to be running all the time while in-game. However, Lutris only allows 1 application to launch from the “Play” button. So before you hit the play button, first you need to click “Run EXE inside wine prefix” and browse to <code>drive_c\Program Files (x86)\Zwift\ZwiftLauncher</code>. You should see that familiar blank white screen.</p><p>Finally, you can hit the “Play” button and Ride On 👍</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/GhTK0sI1AXA style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe></div></div><div class=post><h1 class=post-title><a href=/blog/how-to-host-your-helm-chart-repository-on-github/>How to host your Helm chart repository on GitHub</a></h1><span class=post-date>Apr 2, 2020 &#183; 8 minute read &#183; <a href=/blog/how-to-host-your-helm-chart-repository-on-github/#disqus_thread>Comments</a></span><p>Since the release of Helm 3, the official <a href=https://github.com/helm/charts>helm/charts</a> repository has been deprecated in favour of <a href=https://hub.helm.sh/>Helm Hub</a>. While it&rsquo;s great for decentralization and the long term sustainability of the project, I think there&rsquo;s a lot more that is lost. Where is the best place to go for of the expert advice now? Installing Helm now requires you to manually add each repository you use. And there&rsquo;s now some added friction to hosting your Helm charts.</p><p>Thankfully GitHub has all the tools required, in the form of <a href=https://pages.github.com/>GitHub Pages</a> and <a href=https://github.com/features/actions>GitHub Actions</a>, to host a fully automated build pipeline and to host a repository for your Helm charts. Also, we can use some of the tools from the community to ensure our charts are high quality.</p><h2 id=github-pages>GitHub Pages</h2><p>First you need to go ahead and create a <code>gh-pages</code> branch in your repository. As I&rsquo;m writing this there&rsquo;s <a href=https://github.com/helm/chart-releaser-action/issues/10>an issue</a> open to do this automatically, but to do it manually you can run the following:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>git checkout --orphan gh-pages
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>git rm -rf .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>git commit -m <span style=color:#d14>&#34;Initial commit&#34;</span> --allow-empty
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>git push
</span></span></code></pre></div><p>Once you&rsquo;ve done that, you need to enable GitHub Pages in your repository. Go to the settings page on your repository and set the source branch to the <code>gh-pages</code> branch you just created.</p><p><img src=/img/github-pages.png alt="GitHub Pages"></p><p>Now you&rsquo;ve configured GitHub Pages, it will act as your Helm repository. Next, you need to configure GitHub Actions to publish to there.</p><h2 id=github-actions>GitHub Actions</h2><p>You&rsquo;re going to use GitHub Actions to create two workflows: one for pull requests, and one for commits to master. Your pull request workflow will deal with linting and testing your chart using a collection of automated tooling. While this isn&rsquo;t a direct replacement for the expert advice offered by the Helm community, it&rsquo;s better than nothing. Your master branch workflow will deal with releasing your charts using GitHub pages, meaning you never have to do it manually.</p><p>First up let&rsquo;s look at the pull request workflow.</p><h2 id=pull-requests>Pull requests</h2><p>For each pull request in your chart repository, you want to run a series of different validation and linting tools to catch any avoidable mistakes in your Helm charts. To do that, go ahead and create a workflow in your repository by creating a file at <code>.github/workflows/ci.yaml</code> and add the following YAML to it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:navy>name</span>:<span style=color:#bbb> </span>Lint and Test Charts<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb></span><span style=color:navy>on</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>  </span><span style=color:navy>pull_request</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>    </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>      </span>- <span style=color:#d14>&#39;charts/**&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#bbb></span><span style=color:navy>jobs</span>:<span style=color:#bbb>
</span></span></span></code></pre></div><p>This will run the workflow on any pull request that changes files under the charts directory.</p><p>That&rsquo;s the skeleton of the workflow sorted, next onto the tools that you&rsquo;re going to use.</p><h3 id=chart-testing>Chart Testing</h3><p>The Helm project created Chart Testing, AKA <code>ct</code>, as a comprehensive linting tool for Helm charts. To use it in your pull request build, you&rsquo;ll go ahead and add the following job:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:navy>lint-chart</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>  </span><span style=color:navy>runs-on</span>:<span style=color:#bbb> </span>ubuntu-latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb>  </span><span style=color:navy>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Checkout<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>actions/checkout@v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Run chart-testing (lint)<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>helm/chart-testing-action@master<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>      </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>        </span><span style=color:navy>command</span>:<span style=color:#bbb> </span>lint<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>        </span><span style=color:navy>config</span>:<span style=color:#bbb> </span>.github/ct.yaml<span style=color:#bbb>
</span></span></span></code></pre></div><p>Where <code>ct.yaml</code> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:navy>helm-extra-args</span>:<span style=color:#bbb> </span>--timeout 600<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb></span><span style=color:navy>check-version-increment</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb></span><span style=color:navy>debug</span>:<span style=color:#bbb> </span><span style=color:#000;font-weight:700>true</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>For a full list of configuration options check out this <a href=https://github.com/helm/chart-testing/blob/master/pkg/config/test_config.yaml>sample file</a>.</p><p>The <code>lint</code> action for Chart Testing is a bit of a catch-all that helps you prevent a lot of potential bugs or mistakes in your charts. That includes:</p><ul><li>Version checking</li><li>YAML schema validation on <code>Chart.yaml</code></li><li>YAML linting on <code>Chart.yaml</code> and <code>values.yaml</code></li><li>Maintainer validation on changed charts</li></ul><h3 id=helm-docs>Helm-docs</h3><p>Helm-docs isn&rsquo;t strictly a linting tool, but it makes sure that your documentation stays up-to-date with the current state of your chart. It requires that you create a <code>README.md.gotmpl</code> in each chart repository using the <a href=https://github.com/norwoodj/helm-docs#available-templates>available templates</a>, otherwise it will create a <code>README.md</code> for you using a default template.</p><p>To use it as part of your pull request build, you need to add the following job:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:navy>lint-docs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>runs-on</span>:<span style=color:#bbb> </span>ubuntu-latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>  </span><span style=color:navy>needs</span>:<span style=color:#bbb> </span>lint-chart<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>  </span><span style=color:navy>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Checkout<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>actions/checkout@v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Run helm-docs<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#bbb>      </span><span style=color:navy>run</span>:<span style=color:#bbb> </span>.github/helm-docs.sh<span style=color:#bbb>
</span></span></span></code></pre></div><p>Where <a href=http://helm-docs.sh><code>helm-docs.sh</code></a> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#0086b3>set</span> -euo pipefail
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:teal>HELM_DOCS_VERSION</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;0.11.0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#998;font-style:italic># install helm-docs</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>curl --silent --show-error --fail --location --output /tmp/helm-docs.tar.gz https://github.com/norwoodj/helm-docs/releases/download/v<span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>HELM_DOCS_VERSION</span><span style=color:#d14>}</span><span style=color:#d14>&#34;</span>/helm-docs_<span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>HELM_DOCS_VERSION</span><span style=color:#d14>}</span><span style=color:#d14>&#34;</span>_Linux_x86_64.tar.gz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>tar -xf /tmp/helm-docs.tar.gz helm-docs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#998;font-style:italic># validate docs</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>./helm-docs
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>git diff --exit-code
</span></span></code></pre></div><p>This runs Helm-docs against each chart in your repository and generates the <code>README.md</code> for each one. Then, using git, you&rsquo;ll fail the build if there are any differences. This ensures that you can&rsquo;t check in any changes to your charts without also updating the documentation.</p><h3 id=kubeval>Kubeval</h3><p>Next up is Kubeval. It validates the output from Helm against schemas generated from the Kubernetes OpenAPI specification. You&rsquo;re going to add it to your pull request, and use it to validate across multiple different versions of Kubernetes. Add the following job:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:navy>kubeval-chart</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>  </span><span style=color:navy>runs-on</span>:<span style=color:#bbb> </span>ubuntu-latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb>  </span><span style=color:navy>needs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>    </span>- lint-chart<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>    </span>- lint-docs<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>  </span><span style=color:navy>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>    </span><span style=color:navy>matrix</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>      </span><span style=color:navy>k8s</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>        </span>- v1.12.10<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>        </span>- v1.13.12<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>        </span>- v1.14.10<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>        </span>- v1.15.11<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>        </span>- v1.16.8<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>        </span>- v1.17.4<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>  </span><span style=color:navy>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Checkout<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>actions/checkout@v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Run kubeval<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>      </span><span style=color:navy>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb>        </span><span style=color:navy>KUBERNETES_VERSION</span>:<span style=color:#bbb> </span>${{ matrix.k8s }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>      </span><span style=color:navy>run</span>:<span style=color:#bbb> </span>.github/kubeval.sh<span style=color:#bbb>
</span></span></span></code></pre></div><p>Where <a href=http://kubeval.sh><code>kubeval.sh</code></a> is:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#999;font-weight:700;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#999;font-weight:700;font-style:italic></span><span style=color:#0086b3>set</span> -euo pipefail
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:teal>CHART_DIRS</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>$(</span>git diff --find-renames --name-only <span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>$(</span>git rev-parse --abbrev-ref HEAD<span style=color:#000;font-weight:700>)</span><span style=color:#d14>&#34;</span> remotes/origin/master -- charts | grep <span style=color:#d14>&#39;[cC]hart.yaml&#39;</span> | sed -e <span style=color:#d14>&#39;s#/[Cc]hart.yaml##g&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:teal>KUBEVAL_VERSION</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;0.14.0&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:teal>SCHEMA_LOCATION</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;https://raw.githubusercontent.com/instrumenta/kubernetes-json-schema/master/&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#998;font-style:italic># install kubeval</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>curl --silent --show-error --fail --location --output /tmp/kubeval.tar.gz https://github.com/instrumenta/kubeval/releases/download/<span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>KUBEVAL_VERSION</span><span style=color:#d14>}</span><span style=color:#d14>&#34;</span>/kubeval-linux-amd64.tar.gz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>tar -xf /tmp/kubeval.tar.gz kubeval
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#998;font-style:italic># validate charts</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000;font-weight:700>for</span> CHART_DIR in <span style=color:#d14>${</span><span style=color:teal>CHART_DIRS</span><span style=color:#d14>}</span>; <span style=color:#000;font-weight:700>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  helm template <span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>CHART_DIR</span><span style=color:#d14>}</span><span style=color:#d14>&#34;</span> | ./kubeval --strict --ignore-missing-schemas --kubernetes-version <span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>KUBERNETES_VERSION</span>#v<span style=color:#d14>}</span><span style=color:#d14>&#34;</span> --schema-location <span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>SCHEMA_LOCATION</span><span style=color:#d14>}</span><span style=color:#d14>&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#000;font-weight:700>done</span>
</span></span></code></pre></div><p>This script is a bit longer, but if you break it down step-by-step it&rsquo;s essentially:</p><ol><li>Get a list of charts that have been changed between this PR and master branch</li><li>Install Kubeval</li><li>For each chart:<ol><li>Generate the Kubernetes configuration using Helm</li><li>Validatate the configuration using Kubeval</li></ol></li></ol><p>You&rsquo;re doing this for each version of Kubernetes you&rsquo;ve defined in the job, so if you&rsquo;re using an API that isn&rsquo;t available in all versions, Kubeval will fail the build. This help keep backwards compatibility for all of your charts, and makes sure you&rsquo;re not releasing breaking changes accidentally.</p><p>This doesn&rsquo;t guarantee that the chart will actually install successfully on Kubernetes—but that&rsquo;s where Kubernetes in Docker comes in.</p><h3 id=kubernetes-in-docker-kind>Kubernetes in Docker (KIND)</h3><p>Finally you&rsquo;re going to use Chart Testing again to install your Helm charts on a Kubernetes cluster running in the GitHub Actions runner using Kubernetes in Docker (KIND). Like Kubeval, you can create clusters for different versions of Kubernetes.</p><p>KIND doesn&rsquo;t publish Docker images for each version of Kubernetes, so you need to look at the Docker <a href=https://hub.docker.com/r/kindest/node/tags>image tags</a>. That&rsquo;s why the Kubernetes versions in this job won&rsquo;t necessarily match the versions used for the Kubeval job.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:navy>install-chart</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>  </span><span style=color:navy>name</span>:<span style=color:#bbb> </span>install-chart<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb>  </span><span style=color:navy>runs-on</span>:<span style=color:#bbb> </span>ubuntu-latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>  </span><span style=color:navy>needs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>    </span>- lint-chart<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>    </span>- lint-docs<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>    </span>- kubeval-chart<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>  </span><span style=color:navy>strategy</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>    </span><span style=color:navy>matrix</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>      </span><span style=color:navy>k8s</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>        </span>- v1.12.10<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>        </span>- v1.13.12<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>        </span>- v1.14.10<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>        </span>- v1.15.7<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>        </span>- v1.16.4<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>        </span>- v1.17.2<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>  </span><span style=color:navy>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Checkout<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>actions/checkout@v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Create kind ${{ matrix.k8s }} cluster<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>helm/kind-action@master<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bbb>      </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#bbb>        </span><span style=color:navy>node_image</span>:<span style=color:#bbb> </span>kindest/node:${{ matrix.k8s }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#bbb>    </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Run chart-testing (install)<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bbb>      </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>helm/chart-testing-action@master<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#bbb>      </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#bbb>        </span><span style=color:navy>command</span>:<span style=color:#bbb> </span>install<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#bbb>        </span><span style=color:navy>config</span>:<span style=color:#bbb> </span>.github/ct.yaml<span style=color:#bbb>
</span></span></span></code></pre></div><p>So you got a temporary Kubernetes cluster, installed your charts on it, and ran any <a href=https://helm.sh/docs/topics/chart_tests/>helm tests</a> (that you definitely wrote 🙄). This is the ultimate test of your Helm chart—installing and running it. If this passes, and you merge your pull request, you&rsquo;re ready to release!</p><h2 id=releasing>Releasing</h2><p>Remember that <code>gh-pages</code> branch you created earlier? Now you can use it to publish your fully tested Helm chart to.</p><p>You&rsquo;re going to create another GitHub workflow, this time at <code>.github/workflows/release.yaml</code>. This one is going to be significantly simpler:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:navy>name</span>:<span style=color:#bbb> </span>Release Charts<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:navy>on</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>  </span><span style=color:navy>push</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>    </span><span style=color:navy>branches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>      </span>- master<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>    </span><span style=color:navy>paths</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>      </span>- <span style=color:#d14>&#39;charts/**&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb></span><span style=color:navy>jobs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>  </span><span style=color:navy>release</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>    </span><span style=color:navy>runs-on</span>:<span style=color:#bbb> </span>ubuntu-latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>    </span><span style=color:navy>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>      </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Checkout<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>        </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>actions/checkout@v1<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>      </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Configure Git<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>        </span><span style=color:navy>run</span>:<span style=color:#bbb> </span>|<span style=color:#d14>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#d14>          git config user.name &#34;$GITHUB_ACTOR&#34;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#d14>          git config user.email &#34;$GITHUB_ACTOR@users.noreply.github.com&#34;</span><span style=color:#bbb>          
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb>      </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Run chart-releaser<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>        </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>helm/chart-releaser-action@master<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bbb>        </span><span style=color:navy>env</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#bbb>          </span><span style=color:navy>CR_TOKEN</span>:<span style=color:#bbb> </span><span style=color:#d14>&#39;${{ secrets.CR_TOKEN }}&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>It will check out the repository, set the configuration of Git to the user that kicked-off the workflow, and run the chart releaser action. The chart releaser action will package the chart, create a release from it, and update the <code>index.yaml</code> file in the <code>gh-pages</code> branch. Simple!</p><p>But one thing you still need to do is create a secret in your repository, <code>CR_TOKEN</code>, which contains a GitHub <a href=https://help.github.com/en/github/authenticating-to-github/creating-a-personal-access-token-for-the-command-line#creating-a-token>personal access token</a> with <code>repo</code> scope. This is due to a <a href=https://github.community/t5/GitHub-Actions/Github-action-not-triggering-gh-pages-upon-push/m-p/31266/highlight/true#M743>GitHub Actions bug</a>, where GitHub Pages is not deployed when pushing from GitHub Actions.</p><p><img src=/img/github-secrets.png alt="GitHub Secrets"></p><p>Once that&rsquo;s all configured, any time a change under the charts directory is checked in, like from a pull request, your Github workflow will run and your charts will be available almost instantly!</p><h2 id=next-steps>Next steps</h2><p>From here you&rsquo;ll want to add your repository to Helm so you can use it, and share it on <a href=https://hub.helm.sh/>Helm Hub</a> so others can too. For the former, you&rsquo;ll need to run:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>helm repo add renovate https://&lt;username&gt;.github.io/&lt;repository&gt;/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>helm repo update
</span></span></code></pre></div><p>And for the latter, the Helm project have written <a href=https://github.com/helm/hub/blob/master/Repositories.md>a comprehensive guide</a> that I couldn&rsquo;t possibly top.</p><p>If you want to see all these pieces working together checkout the <a href=https://github.com/renovatebot/helm-charts>renovatebot/helm-charts</a> repository, or our page on <a href=https://hub.helm.sh/charts/renovate/renovate>Helm Hub</a>. And if you would like some help please reach out to me on Twitter at <a href=https://twitter.com/Jamie_Magee>@Jamie_Magee</a>.</p></div><div class=post><h1 class=post-title><a href=/blog/7-tips-for-converting-csharp-code-to-async-await/>7 tips for converting C# code to async/await</a></h1><span class=post-date>Mar 16, 2020 &#183; 5 minute read &#183; <a href=/blog/7-tips-for-converting-csharp-code-to-async-await/#disqus_thread>Comments</a></span><p>Over the past year I&rsquo;ve moved from working mainly in Java, to working mainly in C#. To be honest, Java and C# have more in common than not, but one of the major differences is async/await. It&rsquo;s a really powerful tool if used correctly, but also a very quick way to shoot yourself in the foot.</p><p>Asynchronous programming looks very similar to synchronous programming. However, there are some core concepts which need to be understood in order to form a proper mental model when converting between synchronous and asynchronous programming patterns.</p><p>Here are some of the most common ones I&rsquo;ve come across.</p><h2 id=naming>Naming</h2><p>Method names must use the suffix Async when returning a <code>Task</code> or <code>Task&lt;T></code>. Consistency is key as the <code>Async</code> suffix provides not only a mental signal to the caller that the await keyword should be used, but also provides a consistent naming convention.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#998;font-style:italic>// Synchronous method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>void</span> DoSomething() { <span style=color:#a61717;background-color:#e3d2d2>…</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#998;font-style:italic>// Asynchronous method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task DoSomethingAsync() { <span style=color:#a61717;background-color:#e3d2d2>…</span> }
</span></span></code></pre></div><h2 id=return-types>Return types</h2><p>Every async method returns a <code>Task</code>. Use <code>Task</code> when there is no specific result for the method, which is synonymous with <code>void</code>. Use <code>Task&lt;T></code> when a return value is required.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// Original method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>void</span> DoSomething()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#000;font-weight:700>using</span> (<span style=color:#458;font-weight:700>var</span> client = <span style=color:#000;font-weight:700>new</span> HttpClient())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        client.GetAsync().Result;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#998;font-style:italic>// BAD: This utilizes an anti-pattern. async void provides no mechanism</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#998;font-style:italic>// for the caller to observe the result, including exceptions.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> <span style=color:#000;font-weight:700>void</span> DoSomethingAsync()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#000;font-weight:700>using</span> (<span style=color:#458;font-weight:700>var</span> client = <span style=color:#000;font-weight:700>new</span> HttpClient())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#000;font-weight:700>await</span> client.GetAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#998;font-style:italic>// GOOD: This provides proper access to the completion task. The caller may now</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#998;font-style:italic>// await the method call and observe/handle results and exceptions correctly.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task DoSomethingAsync()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#000;font-weight:700>using</span> (<span style=color:#458;font-weight:700>var</span> client = <span style=color:#000;font-weight:700>new</span> HttpClient())
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#000;font-weight:700>await</span> client.GetAsync();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>}
</span></span></code></pre></div><h2 id=parameters>Parameters</h2><p>There is not a way for the compiler to manage <code>ref</code> and <code>out</code> parameters. (That&rsquo;s a topic for another time.) When multiple values need to be returned you should either use custom objects or a <code>Tuple</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// Original method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#458;font-weight:700>bool</span> TryGet(<span style=color:#458;font-weight:700>string</span> key, <span style=color:#000;font-weight:700>out</span> <span style=color:#458;font-weight:700>string</span> <span style=color:#000;font-weight:700>value</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#000;font-weight:700>value</span> = <span style=color:#000;font-weight:700>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#000;font-weight:700>if</span> (!m_cache.TryGetValue(key, <span style=color:#000;font-weight:700>out</span> <span style=color:#000;font-weight:700>value</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        <span style=color:#000;font-weight:700>value</span> = GetValueFromSource(key);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#000;font-weight:700>value</span> != <span style=color:#000;font-weight:700>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#998;font-style:italic>// New method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task&lt;(<span style=color:#458;font-weight:700>bool</span> exists, <span style=color:#458;font-weight:700>string</span> <span style=color:#000;font-weight:700>value</span>)&gt; TryGetAsync(<span style=color:#458;font-weight:700>string</span> key)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#458;font-weight:700>string</span> <span style=color:#000;font-weight:700>value</span> = <span style=color:#000;font-weight:700>null</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>if</span> (!m_cache.TryGetValue(key, <span style=color:#000;font-weight:700>out</span> <span style=color:#000;font-weight:700>value</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#000;font-weight:700>value</span> = <span style=color:#000;font-weight:700>await</span> GetValueFromSourceAsync(key);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#000;font-weight:700>return</span> (<span style=color:#000;font-weight:700>value</span> != <span style=color:#000;font-weight:700>null</span>, <span style=color:#000;font-weight:700>value</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>}
</span></span></code></pre></div><h2 id=delegates>Delegates</h2><p>Following up on the lack of the <code>void</code> return type, no async method should be defined as an <code>Action</code> variant. When accepting a delegate to an asynchronous method, the asynchronous pattern should be propagated by accepting <code>Func&lt;Task></code> or <code>Func&lt;Task&lt;T>></code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>void</span> TraceHelper(Action action)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Trace.WriteLine(<span style=color:#d14>&#34;calling action&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    action();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Trace.WriteLine(<span style=color:#d14>&#34;called action&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#998;font-style:italic>// Action =&gt; Func&lt;Task&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic>// Action&lt;T&gt; maps to Func&lt;T, Task&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#998;font-style:italic>// etc.</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>async</span> Task TraceHelperAsync(Func&lt;Task&gt; action)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    Trace.WriteLine(<span style=color:#d14>&#34;calling action&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#000;font-weight:700>await</span> action();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    Trace.WriteLine(<span style=color:#d14>&#34;called action&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#998;font-style:italic>// Example call to the method with a synchronous callback implementation</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#000;font-weight:700>await</span> TraceHelperAsync(() =&gt; { Console.WriteLine(<span style=color:#d14>&#34;Called me&#34;</span>); <span style=color:#000;font-weight:700>return</span> Task.CompletedTask; });
</span></span></code></pre></div><h2 id=virtual-methods>Virtual methods</h2><p>In asynchronous programming there is no concept of a <code>void</code> return type, as the basis of the model is that each method returns a mechanism for signalling completion of the asynchronous work. When converting base classes which have empty implementations or return constant values, the framework provides methods and helpers to facilitate the pattern.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// The original synchronous version of the class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>MyClass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    <span style=color:#000;font-weight:700>protected</span> <span style=color:#000;font-weight:700>virtual</span> <span style=color:#000;font-weight:700>void</span> DoStuff()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#998;font-style:italic>// Do nothing</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#000;font-weight:700>protected</span> <span style=color:#000;font-weight:700>virtual</span> <span style=color:#458;font-weight:700>int</span> GetValue()
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#998;font-style:italic>// The converted asynchronous version of the class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>MyClass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    <span style=color:#000;font-weight:700>protected</span> <span style=color:#000;font-weight:700>virtual</span> Task DoStuffAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#998;font-style:italic>// This static accessor avoids new allocations for synchronous &#39;no-op&#39; methods such as this</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        <span style=color:#000;font-weight:700>return</span> Task.CompletedTask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    <span style=color:#000;font-weight:700>protected</span> <span style=color:#000;font-weight:700>virtual</span> Task&lt;<span style=color:#458;font-weight:700>int</span>&gt; GetValueAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#998;font-style:italic>// This factory method returns a completed task with the specified result</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>        <span style=color:#000;font-weight:700>return</span> Task.FromResult(<span style=color:#099>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>}
</span></span></code></pre></div><h2 id=interfaces>Interfaces</h2><p>Like delegates, interfaces should always be declared async which ensures an async-aware model throughout the stack.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>interface</span> <span style=color:#458;font-weight:700>IMyPlugin</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    Task DoStuffAsync(CancellationToken cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Task&lt;<span style=color:#458;font-weight:700>int</span>&gt; DoMoreAsync(CancellationToken cancellationToken);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000;font-weight:700>public</span> <span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>MyPluginImpl</span> : IMyPlugin
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#998;font-style:italic>// When the method does not have a result, use the static accessor</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#000;font-weight:700>public</span> Task DoStuffAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        DoSomething();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#000;font-weight:700>return</span> Task.CompletedTask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#998;font-style:italic>// When the method has a result, use the static factory function</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    <span style=color:#000;font-weight:700>public</span> Task&lt;<span style=color:#458;font-weight:700>int</span>&gt; DoMoreAsync(CancellationToken cancellationToken)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        DoSomething();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        <span style=color:#000;font-weight:700>return</span> Task.FromResult(<span style=color:#099>0</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>}
</span></span></code></pre></div><h2 id=mocks>Mocks</h2><p>In certain cases, mostly unit test mocks, you may find the need to implement interfaces without having any reason to actually perform any asynchronous calls. In these specific cases it is OK to feign asynchronous execution using <code>Task.CompletedTask</code> or <code>Task.FromResult&lt;T>(T result)</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cs data-lang=cs><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#998;font-style:italic>// Example mock implementation for testing. Moq is not smart enough to generate a non-null completed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#998;font-style:italic>// task by default, so you will need to explicitly mock out all methods</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>Mock&lt;IMyPlugin&gt; mockPlugin = <span style=color:#000;font-weight:700>new</span> Mock&lt;IMyPlugin&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#998;font-style:italic>// When a constant value is returned</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>mockPlugin.Setup(x =&gt; x.DoStuffAsync(It.IsAny&lt;CancellationToken&gt;()).Returns(Task.CompletedTask);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>mockPlugin.Setup(x =&gt; x.DoMoreAsync(It.IsAny&lt;CancellationToken&gt;()).ReturnsAsync(<span style=color:#099>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic>// When a dynamic value is returned</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>mockPlugin.Setup(x =&gt; x.DoStuffAsync(It.IsAny&lt;CancellationToken&gt;()).Returns(() =&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>     DoStuffImpl();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>     <span style=color:#000;font-weight:700>return</span> Task.CompletedTask;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>});
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>mockPlugin.Setup(x =&gt; x.DoMoreAsync(It.IsAny&lt;CancellationToken&gt;()).Returns(() =&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>     DoMoreImpl();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>     <span style=color:#000;font-weight:700>return</span> Task.FromResult(<span style=color:#099>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>});
</span></span></code></pre></div><h2 id=summary>Summary</h2><p>Overall asynchronous programming is much better for performance, but requires a slightly different mental model. I hope these tips help!</p></div><div class=post><h1 class=post-title><a href=/blog/automated-dependency-updates/>Automated Dependency Updates</a></h1><span class=post-date>Oct 23, 2019 &#183; 1 minute read &#183; <a href=/blog/automated-dependency-updates/#disqus_thread>Comments</a></span><p>At <a href=https://copenhagenjs.dk>CopenhagenJS</a> in August I was able to share my work on <a href=https://renovatebot.com/>Renovate</a>—a universal dependency update tool—and how you can use it to save time and improve security in software projects.</p><p>If you want to find out more about Renovate you can find us <a href=https://github.com/renovatebot/renovate>on GitHub</a>.</p><style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style><div class=embed-container><iframe src=https://www.youtube.com/embed/yAntIlemF28 frameborder=0 allowfullscreen></iframe></div></div><div class=pagination><a class=pagination-item href=/page/2/>Newer</a>
<a class=pagination-item href=/page/4/>Older</a></div></div></div><script type=text/javascript>var disqus_shortname="jamiemagee";(function(){var e=document.createElement("script");e.async=!0,e.type="text/javascript",e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(e)})()</script></body></html>