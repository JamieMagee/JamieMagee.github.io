<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta name=generator content="Hugo 0.119.0"><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Jamie Magee &#183; Jamie Magee</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=font><link rel=preload href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2')}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link href=/favicon.ico rel=icon><link rel=alternate type=application/rss+xml href=/index.xml title="Jamie Magee"><meta name=description content><meta name=keywords content><meta property="og:title" content="Jamie Magee"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="/"><meta name=twitter:card content="summary"><meta name=twitter:title content="Jamie Magee"><meta name=twitter:description content></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa fa-github-square fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa fa-linkedin-square fa-3x"></i></a>
<a href=http://twitter.com/Jamie_Magee><i class="fa fa-twitter-square fa-3x"></i></a></li></ul><p>&copy; 2023. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=posts><div class=post><h1 class=post-title><a href=/blog/honey-i-shrunk-the-npm-package/>Honey, I shrunk the npm package</a></h1><span class=post-date>Sep 27, 2023 &#183; 11 minute read &#183; <a href=/blog/honey-i-shrunk-the-npm-package/#disqus_thread>Comments</a></span><p>Have you ever wondered what lies beneath the surface of an npm package? At its heart, it’s nothing more than a gzipped tarball. Working in software development, source code and binary artifacts are nearly always shipped as <code>.tar.gz</code> or <code>.tgz</code> files. And gzip compression is supported by every HTTP server and web browser out there. <a href=http://caniuse.com>caniuse.com</a> doesn’t even give statistics for support, it just says “<a href=https://caniuse.com/sr_content-encoding-gzip>supported in effectively all browsers</a>”. But here&rsquo;s the kicker: gzip is starting to show its age, making way for newer, more modern compression algorithms like Brotli and ZStandard. Now, imagine a world where npm embraces one of these new algorithms. In this blog post, I&rsquo;ll dive into the realm of compression and explore the possibilities of modernising npm&rsquo;s compression strategy.</p><h2 id=whats-the-competition>What’s the competition?</h2><p>The two major players in this space are Brotli and ZStandard (or zstd for short). Brotli was released by Google in 2013 and zstd was released by Facebook in 2016. They’ve since been standardised, in <a href=https://datatracker.ietf.org/doc/html/rfc7932>RFC 7932</a> and <a href=https://datatracker.ietf.org/doc/html/rfc8478>RFC 8478</a> respectively, and have seen widespread use all over the software industry. It was actually <a href=https://archlinux.org/news/now-using-zstandard-instead-of-xz-for-package-compression/>the announcement</a> by Arch Linux that they were going to start compressing their packages with zstd by default that made think about this in the first place. Arch Linux was by no means the first project, nor is it the only one. But to find out if it makes sense for the Node ecosystem, I need to do some benchmarks. And that means breaking out <code>tar</code>.</p><h2 id=benchmarking-part-1>Benchmarking part 1</h2><figure><img src=/img/xkcd-1168.png alt=https://xkcd.com/1168/ title="I don't know what's worse--the fact that after 15 years of using tar I still can't keep the flags straight, or that after 15 years of technological advancement I'm still mucking with tar flags that were 15 years old when I started."><figcaption>https://xkcd.com/1168</figcaption></figure><p>I’m going to start with <code>tar</code> and see what sort of comparisons I can get by switching gzip, Brotli, and zstd. I’ll test with <a href=https://www.npmjs.com/package/npm>the npm package of npm itself</a> as it’s a pretty popular package, averaging over 4 million downloads a week, while also being quite large at around 11MB unpacked.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ curl --remote-name https://registry.npmjs.org/npm/-/npm-9.7.1.tgz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ ls -l --human npm-9.7.1.tgz 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>-rw-r--r-- <span style=color:#099>1</span> jamie users 2.6M Jun <span style=color:#099>16</span> 20:30 npm-9.7.1.tgz 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>$ tar --extract --gzip --file npm-9.7.1.tgz
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>$ du --summarize --human --apparent-size package
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>11M	package
</span></span></code></pre></div><p>gzip is already giving good results, compressing 11MB to 2.6MB for a compression ratio of around 0.24. But what can the contenders do? I’m going to stick with the default options for now:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ brotli --version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>brotli 1.0.9
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>$ tar --use-compress-program brotli --create --file npm-9.7.1.tar.br package
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>$ zstd --version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>*** Zstandard CLI <span style=color:#000;font-weight:700>(</span>64-bit<span style=color:#000;font-weight:700>)</span> v1.5.5, by Yann Collet ***
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>$ tar --use-compress-program zstd --create --file npm-9.7.1.tar.zst package
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>$ ls -l --human npm-9.7.1.tgz npm-9.7.1.tar.br npm-9.7.1.tar.zst 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>-rw-r--r-- <span style=color:#099>1</span> jamie users 1.6M Jun <span style=color:#099>16</span> 21:14 npm-9.7.1.tar.br
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>-rw-r--r-- <span style=color:#099>1</span> jamie users 2.3M Jun <span style=color:#099>16</span> 21:14 npm-9.7.1.tar.zst
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>-rw-r--r-- <span style=color:#099>1</span> jamie users 2.6M Jun <span style=color:#099>16</span> 20:30 npm-9.7.1.tgz 
</span></span></code></pre></div><p>Wow! With no configuration both Brotli and zstd come out ahead of gzip, but Brotli is the clear winner here. It manages a compression ratio of 0.15 versus zstd’s 0.21. In real terms that means a saving of around 1MB. That doesn’t sound like much, but at 4 million weekly downloads, that would save 4TB of bandwidth per week.</p><h2 id=benchmarking-part-2-electric-boogaloo>Benchmarking part 2: Electric boogaloo</h2><p>The compression ratio is only telling half of the story. Actually, it’s a third of the story, but compression speed isn’t really a concern. Compression of a package only happens once, when a package is published, but decompression happens every time you run <code>npm install</code>. So any time saved decompressing packages means quicker install or build steps.</p><p>To test this, I’m going to use <a href=https://github.com/sharkdp/hyperfine>hyperfine</a>, a command-line benchmarking tool. Decompressing each of the packages I created earlier 100 times should give me a good idea of the relative decompression speed.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ hyperfine --runs <span style=color:#099>100</span> --export-markdown hyperfine.md <span style=color:#d14>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#d14></span>  <span style=color:#d14>&#39;tar --use-compress-program brotli --extract --file npm-9.7.1.tar.br --overwrite&#39;</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#d14></span>  <span style=color:#d14>&#39;tar --use-compress-program zstd --extract --file npm-9.7.1.tar.zst --overwrite&#39;</span> <span style=color:#d14>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#d14></span>  <span style=color:#d14>&#39;tar --use-compress-program gzip --extract --file npm-9.7.1.tgz --overwrite&#39;</span>
</span></span></code></pre></div><table><thead><tr><th>Command</th><th>Mean [ms]</th><th>Min [ms]</th><th>Max [ms]</th><th>Relative</th></tr></thead><tbody><tr><td>tar &ndash;use-compress-program brotli &ndash;extract &ndash;file npm-9.7.1.tar.br &ndash;overwrite</td><td>51.6 ± 3.0</td><td>47.9</td><td>57.3</td><td>1.31 ± 0.12</td></tr><tr><td>tar &ndash;use-compress-program zstd &ndash;extract &ndash;file npm-9.7.1.tar.zst &ndash;overwrite</td><td>39.5 ± 3.0</td><td>33.5</td><td>51.8</td><td>1.00</td></tr><tr><td>tar &ndash;use-compress-program gzip &ndash;extract &ndash;file npm-9.7.1.tgz &ndash;overwrite</td><td>47.0 ± 1.7</td><td>44.0</td><td>54.9</td><td>1.19 ± 0.10</td></tr></tbody></table><p>This time zstd comes out in front, followed by gzip and Brotli. This makes sense, as “real-time compression” is one of the big features that is touted in <a href=https://facebook.github.io/zstd/>zstd’s documentation</a>. While Brotli is 31% slower compared to zstd, in real terms it&rsquo;s only 12ms. And compared to gzip, it’s only 5ms slower. To put that into context, you’d need a more than 1Gbps connection to make up for the 5ms loss it has in decompression compared with the 1MB it saves in package size.</p><h2 id=benchmarking-part-3-this-time-its-serious>Benchmarking part 3: This time it’s serious</h2><p>Up until now I’ve just been looking at Brotli and zstd’s default settings, but both have a lot of knobs and dials that you can adjust to change the compression ratio and compression or decompression speed. Thankfully, the industry standard <a href=https://github.com/inikep/lzbench>lzbench</a> has got me covered. It can run through all of the different quality levels for each compressor, and spit out a nice table with all the data at the end.</p><p>But before I dive in, there are a few caveats I should point out. The first is that lzbench isn’t able to compress an entire directory like <code>tar</code> , so I opted to use <code>lib/npm.js</code> for this test. The second is that lzbench doesn’t include the gzip tool. Instead it uses zlib, the underlying gzip library. The last is that the versions of each compressor aren’t quite current. The latest version of zstd is 1.5.5, released on April 4th 2023, whereas lzbench uses version 1.4.5, released on May 22nd 2020. The latest version of Brotli is 1.0.9, released on August 27th 2020, whereas lzbench uses a version released on October 1st 2019.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ lzbench -o1 -ezlib/zstd/brotli package/lib/npm.js
</span></span></code></pre></div><details><summary>Click to expand results</summary><table><thead><tr><th>Compressor name</th><th>Compression</th><th>Decompress.</th><th>Compr. size</th><th>Ratio</th><th>Filename</th></tr></thead><tbody><tr><td>memcpy</td><td>117330 MB/s</td><td>121675 MB/s</td><td>13141</td><td>100.00</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -1</td><td>332 MB/s</td><td>950 MB/s</td><td>5000</td><td>38.05</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -2</td><td>382 MB/s</td><td>965 MB/s</td><td>4876</td><td>37.11</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -3</td><td>304 MB/s</td><td>986 MB/s</td><td>4774</td><td>36.33</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -4</td><td>270 MB/s</td><td>1009 MB/s</td><td>4539</td><td>34.54</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -5</td><td>204 MB/s</td><td>982 MB/s</td><td>4452</td><td>33.88</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -6</td><td>150 MB/s</td><td>983 MB/s</td><td>4425</td><td>33.67</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -7</td><td>125 MB/s</td><td>983 MB/s</td><td>4421</td><td>33.64</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -8</td><td>92 MB/s</td><td>989 MB/s</td><td>4419</td><td>33.63</td><td>package/lib/npm.js</td></tr><tr><td>zlib 1.2.11 -9</td><td>95 MB/s</td><td>986 MB/s</td><td>4419</td><td>33.63</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -1</td><td>594 MB/s</td><td>1619 MB/s</td><td>4793</td><td>36.47</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -2</td><td>556 MB/s</td><td>1423 MB/s</td><td>4881</td><td>37.14</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -3</td><td>510 MB/s</td><td>1560 MB/s</td><td>4686</td><td>35.66</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -4</td><td>338 MB/s</td><td>1584 MB/s</td><td>4510</td><td>34.32</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -5</td><td>275 MB/s</td><td>1647 MB/s</td><td>4455</td><td>33.90</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -6</td><td>216 MB/s</td><td>1656 MB/s</td><td>4439</td><td>33.78</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -7</td><td>140 MB/s</td><td>1665 MB/s</td><td>4422</td><td>33.65</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -8</td><td>101 MB/s</td><td>1714 MB/s</td><td>4416</td><td>33.60</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -9</td><td>97 MB/s</td><td>1673 MB/s</td><td>4410</td><td>33.56</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -10</td><td>97 MB/s</td><td>1672 MB/s</td><td>4410</td><td>33.56</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -11</td><td>37 MB/s</td><td>1665 MB/s</td><td>4371</td><td>33.26</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -12</td><td>27 MB/s</td><td>1637 MB/s</td><td>4336</td><td>33.00</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -13</td><td>20 MB/s</td><td>1601 MB/s</td><td>4310</td><td>32.80</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -14</td><td>18 MB/s</td><td>1582 MB/s</td><td>4309</td><td>32.79</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -15</td><td>18 MB/s</td><td>1582 MB/s</td><td>4309</td><td>32.79</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -16</td><td>9.03 MB/s</td><td>1556 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -17</td><td>8.86 MB/s</td><td>1559 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -18</td><td>8.86 MB/s</td><td>1558 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -19</td><td>8.86 MB/s</td><td>1559 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -20</td><td>8.85 MB/s</td><td>1558 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -21</td><td>8.86 MB/s</td><td>1559 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>zstd 1.4.5 -22</td><td>8.86 MB/s</td><td>1589 MB/s</td><td>4305</td><td>32.76</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -0</td><td>604 MB/s</td><td>813 MB/s</td><td>5182</td><td>39.43</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -1</td><td>445 MB/s</td><td>775 MB/s</td><td>5148</td><td>39.18</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -2</td><td>347 MB/s</td><td>947 MB/s</td><td>4727</td><td>35.97</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -3</td><td>266 MB/s</td><td>936 MB/s</td><td>4645</td><td>35.35</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -4</td><td>164 MB/s</td><td>930 MB/s</td><td>4559</td><td>34.69</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -5</td><td>135 MB/s</td><td>944 MB/s</td><td>4276</td><td>32.54</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -6</td><td>129 MB/s</td><td>949 MB/s</td><td>4257</td><td>32.39</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -7</td><td>103 MB/s</td><td>953 MB/s</td><td>4244</td><td>32.30</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -8</td><td>84 MB/s</td><td>919 MB/s</td><td>4240</td><td>32.27</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -9</td><td>7.74 MB/s</td><td>958 MB/s</td><td>4237</td><td>32.24</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -10</td><td>4.35 MB/s</td><td>690 MB/s</td><td>3916</td><td>29.80</td><td>package/lib/npm.js</td></tr><tr><td>brotli 2019-10-01 -11</td><td>1.59 MB/s</td><td>761 MB/s</td><td>3808</td><td>28.98</td><td>package/lib/npm.js</td></tr></tbody></table></details><p>This pretty much confirms what I’ve shown up to now. zstd is able to provide faster decompression speed than either gzip or Brotli, and slightly edge out gzip in compression ratio. Brotli, on the other hand, has comparable decompression speeds and compression ratio with gzip at lower quality levels, but at levels 10 and 11 it’s able to edge out both gzip and zstd’s compression ratio.</p><h2 id=everything-is-derivative>Everything is derivative</h2><p>Now that I’ve finished with benchmarking, I need to step back and look at my original idea of replacing gzip as npm’s compression standard. As it turns out, Evan Hahn had a similar idea in 2022 and proposed <a href=https://github.com/npm/rfcs/pull/595>an npm RFC</a>. He proposed using Zopfli, a backwards-compatible gzip compression library, and Brotli’s older (and cooler 😎) sibling. Zopfli is able to produce smaller artifacts with the trade-off of a much slower compression speed. In theory an easy win for the npm ecosystem. And if you watch <a href="https://www.youtube.com/watch?v=sDsq_i1Q4Lc&amp;t=170s">the RFC meeting recording</a> or read <a href=https://github.com/npm/rfcs/blob/main/meetings/2022-06-01.md#pr-595-propose-backwards-compatible-improvements-to-compression---evanhahn>the meeting notes</a>, everyone seems hugely in favour of the proposal. However, the one big roadblock that prevents this RFC from being immediately accepted, and ultimately results in it being abandoned, is the lack of a native JavaScript implementation.</p><p>Learning from this earlier RFC and my results from benchmarking Brotli and zstd, what would it take to build a strong RFC of my own?</p><h2 id=putting-it-all-together>Putting it all together</h2><p>Both Brotli and zstd’s reference implementations are written in C. And while there are a lot of ports on the npm registry using Emscripten or WASM, Brotli has an implementation in <a href=https://nodejs.org/api/zlib.html>Node.js’s zlib module</a>, and has done <a href=https://nodejs.org/en/blog/release/v10.16.0>since Node.js 10.16.0</a>, released in May 2019. I opened <a href=https://github.com/nodejs/node/issues/48412>an issue in Node.js’s GitHub repo</a> to add support for zstd, but it’ll take a long time to make its way into an LTS release, nevermind the rest of npm’s dependency chain. I was already leaning towards Brotli, but this just seals the deal.</p><p>Deciding on an algorithm is one thing, but implementing it is another. npm’s current support for gzip compression ultimately comes from Node.js itself. But the dependency chain between npm and Node.js is long and slightly different depending on if you’re packing or unpacking a package.</p><p>The dependency chain for packing, as in <code>npm pack</code> or <code>npm publish</code>, is:</p><p><a href=https://www.npmjs.com/package/npm>npm</a> → <a href=https://www.npmjs.com/package/libnpmpack>libnpmpack</a> → <a href=https://www.npmjs.com/package/pacote>pacote</a> → <a href=https://www.npmjs.com/package/tar>tar</a> → <a href=https://www.npmjs.com/package/minizlib>minizlib</a> → <a href=https://nodejs.org/api/zlib.html>zlib</a> (Node.js)</p><p>But the dependency chain for unpacking (or ‘reifying’ as npm calls it), as in <code>npm install</code> or <code>npm ci</code> is:</p><p><a href=https://www.npmjs.com/package/npm>npm</a> → <a href=https://www.npmjs.com/package/@npmcli/arborist>@npmcli/arborist</a> → <a href=https://www.npmjs.com/package/pacote>pacote</a> → <a href=https://www.npmjs.com/package/tar>tar</a> → <a href=https://www.npmjs.com/package/minizlib>minizlib</a> → <a href=https://nodejs.org/api/zlib.html>zlib</a> (Node.js)</p><p>That’s quite a few packages that need to be updated, but thankfully the first steps have already been taken. Support for Brotli was added to minizlib 1.3.0 back in September 2019. I built on top of that and <a href=https://github.com/isaacs/node-tar/pull/391>contributed Brotil support</a> to <code>tar</code>. That is now <a href=https://github.com/isaacs/node-tar/blob/main/CHANGELOG.md#62>available in version 6.2.0</a>. It may take a while, but I can see a clear path forward.</p><p>The final issue is backwards compatibility. This wasn’t a concern with Evan Hahn’s RFC, as Zopfli generates backwards-compatible gzip files. However, Brotli is an entirely new compression format, so I&rsquo;ll need to propose a very careful adoption plan. The process I can see is:</p><ol><li>Support for packing and unpacking is added in a minor release of the current version of npm<ol><li>Unpacking using Brotli is handled transparently</li><li>Packing using Brotli is disabled by default and only enabled if one of the following are true:<ol><li>The <code>engines</code> field in <code>package.json</code> is set to a version of npm that supports Brotli</li><li>The <code>engines</code> field in <code>package.json</code> is set to a version of node that bundles a version of npm that supports Brotli</li><li>Brotli support is explicitly enabled in <code>.npmrc</code></li></ol></li></ol></li><li>Packing using Brotli is enabled by default in the next major release of npm after the LTS version of Node.js that bundles it goes out of support</li></ol><p>Let’s say that Node.js 22 comes with npm 10, which has Brotli support. Node.js 22 will stop getting LTS updates in April 2027. Then, the next major version of npm after that date should enable Brotli packing by default.</p><p>I admit that this is an <em>incredibly</em> long transition period. However, it will guarantee that if you’re using a version of Node.js that is still being supported, there will be no visible impact to you. And it still allows early adopters to opt-in to Brotli support. But if anyone has other ideas about how to do this transition, I am open to suggestions.</p><h2 id=whats-next>What’s next?</h2><p>As I wrap up my exploration into npm compression, I must admit that my journey has only just begun. To push the boundaries further, there are a lot more steps. First and foremost, I need to do some more extensive benchmarking with <a href=https://socket.dev/npm/category/popular>the top 250 most downloaded npm packages</a>, instead of focusing on a single package. Once that’s complete, I need to draft an npm RFC and seek feedback from the wider community. If you&rsquo;re interested in helping out, or just want to see how it&rsquo;s going, you can follow me on Mastodon at <a href=https://infosec.exchange/@JamieMagee>@JamieMagee@infosec.exchange</a>, or on Twitter at <a href=https://twitter.com/Jamie_Magee>@Jamie_Magee</a>.</p></div><div class=post><h1 class=post-title><a href=/blog/container-plumbing-days-2023-windows-containers/>Container Plumbing Days 2023—Windows containers: The forgotten stepchild</a></h1><span class=post-date>May 5, 2023 &#183; 1 minute read &#183; <a href=/blog/container-plumbing-days-2023-windows-containers/#disqus_thread>Comments</a></span><p>When it comes to Linux containers, there are plenty of tools out there that can scan container images, generate Software Bill of Materials (SBOM), or list vulnerabilities. However, Windows container images are more like the forgotten stepchild in the container ecosystem. And that means we’re forgetting the countless developers using Windows containers, too.</p><p>Instead of allowing this gap to widen further, container tool authors—especially SBOM tools and vulnerability scanners—need to add support for Windows container images.</p><p>In my presentation at <a href=https://containerplumbing.org/>Container Plumbing Days 2023</a> I showed how to extract version information from Windows containers images that can be used to generate SBOMs, as well as how to integrate with the Microsoft Security Updates API which can provide detailed vulnerability information.</p><style>.embed-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;max-width:100%}.embed-container iframe,.embed-container object,.embed-container embed{position:absolute;top:0;left:0;width:100%;height:100%}</style><div class=embed-container><iframe src=https://www.youtube.com/embed/RZ4PBDjtrc0 frameborder=0 allowfullscreen></iframe></div></div><div class=post><h1 class=post-title><a href=/blog/your-jest-tests-might-be-wrong/>Your Jest tests might be wrong</a></h1><span class=post-date>May 4, 2023 &#183; 7 minute read &#183; <a href=/blog/your-jest-tests-might-be-wrong/#disqus_thread>Comments</a></span><p>Is your Jest test suite failing you? You might not be using the testing framework&rsquo;s full potential, especially when it comes to preventing state leakage between tests. The Jest settings <a href=https://jestjs.io/docs/configuration#clearmocks-boolean><code>clearMocks</code></a>, <a href=https://jestjs.io/docs/configuration#resetmocks-boolean><code>resetMocks</code></a>, <a href=https://jestjs.io/docs/configuration#restoremocks-boolean><code>restoreMocks</code></a>, and <a href=https://jestjs.io/docs/configuration#resetmodules-boolean><code>resetModules</code></a> are set to <code>false</code> by default. If you haven’t changed these defaults, your tests might be fragile, order-dependent, or just downright wrong. In this blog post, I’ll dig into what each setting does, and how you can fix your tests.</p><h2 id=clearmocks><code>clearMocks</code></h2><p>First up is <code>clearMocks</code>:</p><blockquote><p>Automatically clear mock calls, instances, contexts and results before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestclearallmocks><code>jest.clearAllMocks()</code></a> before each test. This does not remove any mock implementation that may have been provided.</p></blockquote><p>Every Jest mock has some context associated with it. It’s how you’re able to call functions like <code>mockReturnValueOnce</code> instead of only <code>mockReturnValue</code>. But if <code>clearMocks</code> is false by default, then that context can be carried between tests.</p><p>Take this example function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>export</span> <span style=color:#000;font-weight:700>function</span> randomNumber() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>Math</span>.random();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>And this simple test for it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>jest.mock(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>});
</span></span></code></pre></div><p>The test passes and works as expected. However, if we add another test to our test suite:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>jest.mock(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    it(<span style=color:#d14>&#39;should return same number&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>});
</span></span></code></pre></div><p>Our second test fails with the error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#000;font-weight:700>(</span>jest.fn<span style=color:#000;font-weight:700>())</span>.toBeCalledTimes<span style=color:#000;font-weight:700>(</span>expected<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Expected number of calls: <span style=color:#099>2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Received number of calls: <span style=color:#099>3</span>
</span></span></code></pre></div><p>And even worse, if we change the order of our tests:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>jest.mock(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;should return same number&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>});
</span></span></code></pre></div><p>We get the same error as before, but this time for <code>should return 42</code> instead of <code>should return same number</code>.</p><p>Enabling <code>clearMocks</code> in your Jest configuration ensures that every mock’s context is reset between tests. You can achieve the same result by adding <code>jest.clearAllMocks()</code> to your <code>beforeEach()</code> functions. But this isn’t a great idea as it means you have to remember to add it to each test file to make your tests safe, instead of using <code>clearMocks</code> to make them all safe by default.</p><h2 id=resetmocks><code>resetMocks</code></h2><p>Next up is <code>resetMocks</code>:</p><blockquote><p>Automatically reset mock state before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestresetallmocks><code>jest.resetAllMocks()</code></a> before each test. This will lead to any mocks having their fake implementations removed but does not restore their initial implementation.</p></blockquote><p><code>resetMocks</code> takes <code>clearMocks</code> a step further, by clearing the implementation of any mocks. However, you need to use it in addition to <code>clearMocks</code>.</p><p>Going back to my first example again, I’m going to move the mock setup inside the first test case <code>randomNumber.mockReturnValue(42);</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    it(<span style=color:#d14>&#39;should return 42 twice&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>});
</span></span></code></pre></div><p>Logically, you might expect this to fail, but it passes! Jest mocks are global to the file they’re in. It doesn’t matter what <code>describe</code>, <code>it</code>, or <code>test</code> scope you use. And if I change the order of tests again, they fail. This makes it very easy to write tests that leak state and are order-dependent.</p><p>Enabling <code>resetMocks</code> in your Jest context ensures that every mock implementation is reset between tests. Like before, you can also add <code>jest.resetAllMocks()</code> to <code>beforeEach()</code> in every test file. But it’s a much better idea to make your tests safe by default instead of having to opt-in to safe tests.</p><h2 id=restoremocks><strong><code>restoreMocks</code></strong></h2><p>Next is <code>restoreMocks</code>:</p><blockquote><p>Automatically restore mock state and implementation before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestrestoreallmocks><code>jest.restoreAllMocks()</code></a> before each test. This will lead to any mocks having their fake implementations removed and restores their initial implementation.</p></blockquote><p><code>restoreMocks</code> takes test isolation and safety to the next level.</p><p>Let me rewrite my example a little bit, so instead of mocking the function directly, I’m mocking <code>Math.random()</code> instead.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> spy <span style=color:#000;font-weight:700>=</span> jest.spyOn(<span style=color:#0086b3>Math</span>, <span style=color:#d14>&#39;random&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        spy.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    it(<span style=color:#d14>&#39;should return 42 twice&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        spy.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>});
</span></span></code></pre></div><p>With <code>clearMocks</code> and <code>resetMocks</code> enabled, and <code>restoreMocks</code> disabled, my tests pass. But if I enable <code>restoreMocks</code> both tests fail with an error message like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#000;font-weight:700>(</span>received<span style=color:#000;font-weight:700>)</span>.toBe<span style=color:#000;font-weight:700>(</span>expected<span style=color:#000;font-weight:700>)</span> // Object.is equality
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Expected: <span style=color:#099>42</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Received: 0.503533695686772
</span></span></code></pre></div><p><code>restoreMocks</code> has restored the original implementation of <code>Math.random()</code> before each test, so now I’m getting an actual random number instead of my mocked return value of <code>42</code>. This forces me to be explicit about not only the mocked return values I’m expecting, but the mocks themselves.</p><p>To fix my tests I can set up my Jest mocks in each individual test.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#000;font-weight:700>const</span> spy <span style=color:#000;font-weight:700>=</span> jest.spyOn(<span style=color:#0086b3>Math</span>, <span style=color:#d14>&#39;random&#39;</span>).mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    it(<span style=color:#d14>&#39;should return 42 twice&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#000;font-weight:700>const</span> spy <span style=color:#000;font-weight:700>=</span> jest.spyOn(<span style=color:#0086b3>Math</span>, <span style=color:#d14>&#39;random&#39;</span>).mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>});
</span></span></code></pre></div><h2 id=resetmodules><code>resetModules</code></h2><p>Finally, we have <code>resetModules</code>:</p><blockquote><p>By default, each test file gets its own independent module registry. Enabling <code>resetModules</code> goes a step further and resets the module registry before running each individual test. This is useful to isolate modules for every test so that the local module state doesn&rsquo;t conflict between tests. This can be done programmatically using <a href=https://jestjs.io/docs/jest-object#jestresetmodules><code>jest.resetModules()</code></a>.</p></blockquote><p>Again, this builds on top of <code>clearMocks</code>, <code>resetMocks</code>, and <code>restoreMocks</code>. I don’t think this level of isolation is required for most tests, but I’m a completionist.</p><p>Let’s take my example from above and expand it to include some initialization that needs to happen before I can call <code>randomNumber</code>. Maybe I need to make sure there’s enough entropy to generate random numbers? My module might look something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>let</span> isInitialized <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>export</span> <span style=color:#000;font-weight:700>function</span> initialize() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    isInitialized <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000;font-weight:700>export</span> <span style=color:#000;font-weight:700>function</span> randomNumber() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#000;font-weight:700>if</span> (<span style=color:#000;font-weight:700>!</span>isInitialized) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>throw</span> <span style=color:#000;font-weight:700>new</span> <span style=color:#0086b3>Error</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>Math</span>.random();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><p>I also want to write some tests to make sure that this works as expected:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    it(<span style=color:#d14>&#39;does not throw when initialized&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        expect(() <span style=color:#000;font-weight:700>=&gt;</span> random.initialize()).not.toThrow();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;throws when not initialized&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        expect(() <span style=color:#000;font-weight:700>=&gt;</span> random.randomNumber()).toThrow();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>});
</span></span></code></pre></div><p><code>initialize</code> shouldn’t throw an error, but <code>randomNumber</code> should throw an error if <code>initialize</code> isn’t called first. Great! Except it doesn’t work. Instead I get:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#000;font-weight:700>(</span>received<span style=color:#000;font-weight:700>)</span>.toThrow<span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Received <span style=color:#000;font-weight:700>function</span> did not throw
</span></span></code></pre></div><p>That’s because without enabling <code>resetModules</code>, the module is shared between all tests in the file. So when I called <code>random.initialize()</code> in my first test, <code>isInitialized</code> is still true for my second test. But once again, if I were to switch the order of my tests in the file, they would both pass. So my tests are order-dependent again!</p><p>Enabling <code>resetModules</code> will give each test in the file a fresh version of the module for each test. Though, this might actually be a case where you want to use <code>jest.resetAllModules()</code> in your <code>beforeEach()</code> instead of enabling it globally. This kind of isolation isn’t required for every test. And if you’re using <code>import</code> instead of <code>require</code>, the syntax can get very awkward very quickly if you’re trying to avoid an <code>'import' and 'export' may only appear at the top level</code> error.</p><h2 id=tldr-reset-all-of-the-things>TL;DR reset all of the things</h2><p>By default, Jest tests are only isolated at the file level. If you really want to make sure your tests are safe and isolated, add this to your Jest config:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  clearMocks<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  resetMocks<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  restoreMocks<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  resetModules<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span> <span style=color:#998;font-style:italic>// It depends
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#998;font-style:italic></span>}
</span></span></code></pre></div><p>There is <a href=https://github.com/facebook/jest/issues/10242>a suggestion</a> to make this part of the default configuration. But until then, you’ll have to do it yourself.</p></div><div class=post><h1 class=post-title><a href=/blog/maintaining-aur-packages-with-renovate/>Maintaining AUR packages with Renovate</a></h1><span class=post-date>Mar 16, 2023 &#183; 5 minute read &#183; <a href=/blog/maintaining-aur-packages-with-renovate/#disqus_thread>Comments</a></span><p>One big advantage that Arch Linux has over other distributions, apart from being able to say “BTW I use Arch.”, is the Arch User Repository (AUR). It’s a community-driven repository with over 80,000 packages. If you’re looking for a package, chances are you&rsquo;ll find it in the AUR.</p><p>Keeping all those packages up to date, takes a lot of manual effort by a lot of volunteers. People have created and used tools, like <a href=https://github.com/thp/urlwatch><code>urlwatch</code></a> and <a href=https://github.com/eli-schwartz/aurpublish><code>aurpublish</code></a>, to let them know when upstream releases are cut and automate some parts of the process. I know I do. But I wanted to automate the entire process. I think <a href=https://github.com/renovatebot/renovate/>Renovate</a> can help here.</p><h2 id=updating-versions-with-renovate>Updating versions with Renovate</h2><p>Renovate is an automated dependency update tool. You might have seen it opening pull requests on GitHub and making updates for npm or other package managers, but it’s a lot more powerful than just that.</p><p>Renovate has a couple of concepts that I need to explain first: <a href=https://docs.renovatebot.com/modules/datasource>datasources</a> and <a href=https://docs.renovatebot.com/modules/manager/>managers</a>. Datasources define where to look for new versions of a dependency. Renovate comes with over 50 different datasources, but the one that is important for AUR packages is the <a href=https://docs.renovatebot.com/modules/datasource/#git-tags-datasource><code>git-tags</code> datasource</a>. Managers are the Renovate concept for package managers. There isn’t an AUR or <code>PKGBUILD</code> manager, but there is a <a href=https://docs.renovatebot.com/modules/manager/regex/>regex manager</a> that I can use.</p><p>I can create a <code>renovate.json</code> configuration with the following regex manager configuration:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:navy>&#34;regexManagers&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>      <span style=color:navy>&#34;fileMatch&#34;</span>: [<span style=color:#d14>&#34;(^|/)PKGBUILD$&#34;</span>],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>      <span style=color:navy>&#34;matchStrings&#34;</span>: [
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        <span style=color:#d14>&#34;pkgver=(?&lt;currentValue&gt;.*) # renovate: datasource=(?&lt;datasource&gt;.*) depName=(?&lt;depName&gt;.*)&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      ],
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:navy>&#34;extractVersionTemplate&#34;</span>: <span style=color:#d14>&#34;^v?(?&lt;version&gt;.*)$&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  ]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><p>Breaking that down:</p><ul><li>The <code>fileMatch</code> setting tells Renovate to look for any <code>PKGBUILD</code> files in a repository</li><li>The <code>matchStrings</code> is the regex format to extract the version, datasource, and dependency name from the <code>PKGBUILD</code></li><li>The <code>extractVersionTemplate</code> is to handle a “v” in front of any version number that is sometimes added to Git tags</li></ul><p>And here’s an extract from the PKGBUILD for the <a href=https://aur.archlinux.org/packages/bicep-bin>bicep-bin</a> AUR package that I maintain:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:teal>pkgver</span><span style=color:#000;font-weight:700>=</span>0.15.31 <span style=color:#998;font-style:italic># renovate: datasource=github-tags depName=Azure/bicep</span>
</span></span></code></pre></div><p>Here I’m configuring Renovate to use the <a href=https://docs.renovatebot.com/modules/datasource/github-tags/><code>github-tags</code></a> datasource and to look in the <a href=https://github.com/Azure/bicep><code>Azure/bicep</code> GitHub repository</a> for new versions. That means it’ll look in the <a href=https://github.com/Azure/bicep/tags>list of tags for the <code>Azure/bicep</code> repository</a> for any new versions. If Renovate finds any new versions, it’ll automatically update the <code>PKGBUILD</code> and open a pull request with the updated version.</p><p>So I’ve automated the <code>PKGBUILD</code> update, but that’s only half of the work. The checksums and <code>.SRCINFO</code> must be updated before pushing to the AUR. Unfortunately, Renovate can’t do that (yet, see <a href=https://github.com/renovatebot/renovate/issues/16923>Renovate issue #16923</a>), but GitHub Actions can!</p><h2 id=updating-checksums-and-srcinfo-with-github-actions>Updating checksums and <code>.SRCINFO</code> with GitHub Actions</h2><p>Updating the checksums with <code>updpkgsums</code> is easy, and generating an updated <code>.SRCINFO</code> with <code>makepkg --printsrcinfo > .SRCINFO</code> is straightforward too. But doing that for a whole repository of AUR packages is going to be a little trickier. So let me build up the GitHub actions workflow step-by-step.</p><p>First, I only want to run this workflow on pull requests targeting the <code>main</code> branch.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:navy>on</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>pull_request</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>    </span><span style=color:navy>types</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>      </span>- opened<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>      </span>- synchronize<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>    </span><span style=color:navy>branches</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bbb>      </span>- main<span style=color:#bbb>
</span></span></span></code></pre></div><p>Next, I’m going to need to check out the entire history of the repository, so I can compare the files changed in the latest commit with the Git history.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:navy>jobs</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>updpkgsums</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>    </span><span style=color:navy>runs-on</span>:<span style=color:#bbb> </span>ubuntu-latest<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>    </span><span style=color:navy>steps</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>      </span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Checkout<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>        </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c<span style=color:#bbb> </span><span style=color:#998;font-style:italic># v3.3.0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bbb>        </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#bbb>          </span><span style=color:navy>fetch-depth</span>:<span style=color:#bbb> </span><span style=color:#099>0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#bbb>          </span><span style=color:navy>ref</span>:<span style=color:#bbb> </span>${{ github.ref }}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Getting the package that changed in a pull request requires a little bit of shell magic.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Find updated package<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>run</span>:<span style=color:#bbb> </span>|<span style=color:#d14>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#d14>    #!/usr/bin/env bash
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#d14>    set -euxo pipefail
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#d14>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#d14>    echo &#34;pkgbuild=$(git diff --name-only origin/main origin/${GITHUB_HEAD_REF} &#34;*PKGBUILD&#34; | head -1 | xargs dirname)&#34; &gt;&gt; $GITHUB_ENV</span><span style=color:#bbb>    
</span></span></span></code></pre></div><p>Now I’ve found the package that changed in the Renovate pull request, I can update the files.</p><p>This step in the workflow uses a private GitHub Action that I have in my <code>aur-packages</code> repository. I’m not going to break it down here, but at its core it runs <code>updpkgsums</code> and <code>makepkg --printsrcinfo > .SRCINFO</code> with a little extra configuration required to run Arch Linux on GitHub Actions runners. You can <a href=https://github.com/JamieMagee/aur-packages/tree/main/.github/actions/aur>check out the full code on GitHub</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Validate package<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>if</span>:<span style=color:#bbb> </span>${{ env.pkgbuild != &#39;&#39; }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>  </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>./.github/actions/aur<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>  </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>    </span><span style=color:navy>action</span>:<span style=color:#bbb> </span><span style=color:#d14>&#39;updpkgsums&#39;</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>    </span><span style=color:navy>pkgname</span>:<span style=color:#bbb> </span>${{ env.pkgbuild }}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Finally, once the <code>PKGBUILD</code> and <code>.SRCINFO</code> are updated I need to commit that change back to the pull request.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Commit<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>if</span>:<span style=color:#bbb> </span>${{ env.pkgbuild != &#39;&#39; }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>  </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>stefanzweifel/git-auto-commit-action@3ea6ae190baf489ba007f7c92608f33ce20ef04a<span style=color:#bbb> </span><span style=color:#998;font-style:italic># v4.16.0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>  </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>    </span><span style=color:navy>file_pattern</span>:<span style=color:#bbb> </span><span style=color:#d14>&#39;*/PKGBUILD */.SRCINFO&#39;</span><span style=color:#bbb>
</span></span></span></code></pre></div><p>Check out <a href=https://github.com/JamieMagee/aur-packages/pull/62>this pull request for <code>bicep-bin</code></a> where Renovate opened a pull request, and my GitHub Actions workflow updated the <code>b2sums</code> in the <code>PKGBUILD</code> and updated the <code>.SRCINFO</code>.</p><p>But why stop there? Let’s talk about publishing.</p><h2 id=publishing-to-the-aur>Publishing to the AUR</h2><p>Each AUR package is its own Git repository. So to update a package in the AUR, I only need to push a new commit with the updated <code>PKGBUILD</code> and <code>.SRCINFO</code>. Thankfully, <a href=https://github.com/KSXGitHub>KSXGitHub</a> created the <a href=https://github.com/KSXGitHub/github-actions-deploy-aur><code>github-actions-deploy-aur</code> GitHub Action</a> to streamline the whole process.</p><p>If I create a new GitHub Actions workflow to publish to the AUR, I can reuse the first two steps from my previous workflow to check out the repository and find the updated package. Then all I need to do is to use the <code>github-actions-deploy-aur</code> GitHub Action:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>- <span style=color:navy>name</span>:<span style=color:#bbb> </span>Publish package<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>  </span><span style=color:navy>uses</span>:<span style=color:#bbb> </span>KSXGitHub/github-actions-deploy-aur@065b6056b25bdd43830d5a3f01899d0ff7169819<span style=color:#bbb> </span><span style=color:#998;font-style:italic># v2.6.0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>  </span><span style=color:navy>if</span>:<span style=color:#bbb> </span>${{ env.pkgbuild != &#39;&#39; }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb>  </span><span style=color:navy>with</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb>    </span><span style=color:navy>pkgname</span>:<span style=color:#bbb> </span>${{ env.pkgbuild }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>    </span><span style=color:navy>pkgbuild</span>:<span style=color:#bbb> </span>${{ env.pkgbuild }}/PKGBUILD<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bbb>    </span><span style=color:navy>commit_username</span>:<span style=color:#bbb> </span>${{ secrets.AUR_USERNAME }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#bbb>    </span><span style=color:navy>commit_email</span>:<span style=color:#bbb> </span>${{ secrets.AUR_EMAIL }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#bbb>    </span><span style=color:navy>ssh_private_key</span>:<span style=color:#bbb> </span>${{ secrets.AUR_SSH_PRIVATE_KEY }}<span style=color:#bbb>
</span></span></span></code></pre></div><h3 id=all-together-now>All together now</h3><p>If you own any AUR packages and want to automate some of the maintenance burden, check out <a href=https://github.com/JamieMagee/aur-packages-template/>my AUR packages template GitHub repository</a>. It contains all of the steps I showed in this blog post. And if you want to see how it works in practice, check out <a href=https://github.com/JamieMagee/aur-packages>my AUR packages GitHub repository</a>.</p></div><div class=post><h1 class=post-title><a href=/blog/scanning-windows-container-images-is-surprisingly-easy/>Scanning Windows container images is (surprisingly) easy!</a></h1><span class=post-date>Jan 2, 2023 &#183; 5 minute read &#183; <a href=/blog/scanning-windows-container-images-is-surprisingly-easy/#disqus_thread>Comments</a></span><p>When it comes to Linux containers, there are plenty of tools out there that can scan container images, generate Software Bill of Materials (SBOM), or list vulnerabilities. However, Windows container images are more like the forgotten stepchild in the container ecosystem. And that means we’re forgetting the countless developers using Windows containers, too.</p><p>I wanted to see what I’d need to make scanning tools for Windows container images. Turns out it’s pretty easy. So easy, in fact, I think the existing container tools should add support for Windows container images.</p><h2 id=what-version-of-windows-am-i-running>What version of Windows am I running?</h2><p>The first question I needed to answer was: what version of Windows was the container image based on? This tells me what date the container image is from, what updates are applicable, and what vulnerabilities it has.</p><p>Container images are really just <code>tar</code> files, and Windows container images are no different. So first I saved a Windows container image locally using skopeo:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ skopeo --insecure-policy --override-os windows copy docker://mcr.microsoft.com/windows/nanoserver:ltsc2022 dir:///tmp/nanoserver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ ls /tmp/nanoserver
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>0db1879370e5c72dae7bff5d013772cbbfb95f30bfe1660dcef99e0176752f1c  7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858 manifest.json version
</span></span></code></pre></div><p>Next, I inspected the manifest using jq to find the layer that had the Windows files.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ jq . manifest.json
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#d14>&#34;schemaVersion&#34;</span>: 2,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  <span style=color:#d14>&#34;mediaType&#34;</span>: <span style=color:#d14>&#34;application/vnd.docker.distribution.manifest.v2+json&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#d14>&#34;config&#34;</span>: <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    <span style=color:#d14>&#34;mediaType&#34;</span>: <span style=color:#d14>&#34;application/vnd.docker.container.image.v1+json&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#d14>&#34;size&#34;</span>: 638,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#d14>&#34;digest&#34;</span>: <span style=color:#d14>&#34;sha256:0db1879370e5c72dae7bff5d013772cbbfb95f30bfe1660dcef99e0176752f1c&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#000;font-weight:700>}</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#d14>&#34;layers&#34;</span>: <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>      <span style=color:#d14>&#34;mediaType&#34;</span>: <span style=color:#d14>&#34;application/vnd.docker.image.rootfs.foreign.diff.tar&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>      <span style=color:#d14>&#34;size&#34;</span>: 304908800,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>      <span style=color:#d14>&#34;digest&#34;</span>: <span style=color:#d14>&#34;sha256:7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>I then extracted the layer and fixed the permissions.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-shell data-lang=shell><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ mkdir layer
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>$ tar -xf 7d843aa7407d9a5b1678482851d2e81f78b08185b72c18ffb6dfabcfed383858 -C ./layer/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>$ sudo find ./layer -type f -exec chmod <span style=color:#099>0644</span> <span style=color:#000;font-weight:700>{}</span> <span style=color:#d14>\;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>$ sudo find ./layer -type d -exec chmod <span style=color:#099>0755</span> <span style=color:#000;font-weight:700>{}</span> <span style=color:#d14>\;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>$ ls -lah layer/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>total 16K
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>drwxr-xr-x <span style=color:#099>4</span> jamie users 4.0K Dec <span style=color:#099>28</span> 15:05 .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>drwxr-xr-x <span style=color:#099>3</span> jamie users 4.0K Dec <span style=color:#099>28</span> 15:00 ..
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>drwxr-xr-x <span style=color:#099>5</span> jamie users 4.0K Dec  <span style=color:#099>9</span> 01:18 Files
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>drwxr-xr-x <span style=color:#099>3</span> jamie users 4.0K Dec  <span style=color:#099>9</span> 01:22 UtilityVM
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>$ ls -lah layer/Files/
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>total 28K
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>drwxr-xr-x  <span style=color:#099>5</span> jamie users 4.0K Dec  <span style=color:#099>9</span> 01:18 .
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>drwxr-xr-x  <span style=color:#099>4</span> jamie users 4.0K Dec <span style=color:#099>28</span> 15:05 ..
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>-rw-r--r--  <span style=color:#099>1</span> jamie users 5.6K Dec  <span style=color:#099>9</span> 01:18 License.txt
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>drwxr-xr-x  <span style=color:#099>4</span> jamie users 4.0K May  <span style=color:#099>7</span>  <span style=color:#099>2021</span> ProgramData
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>drwxr-xr-x  <span style=color:#099>6</span> jamie users 4.0K Dec  <span style=color:#099>9</span> 01:19 Users
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>drwxr-xr-x <span style=color:#099>20</span> jamie users 4.0K Dec  <span style=color:#099>9</span> 01:19 Windows
</span></span></code></pre></div><p>Inside the extracted layer there are two directories: <code>Files</code> and <code>UtilityVM</code>. <code>Files</code> had the filesystem of the Windows container image, while <code>UtilityVM</code> is used by Hyper-V behind the scenes. So I just needed to focus on <code>Files</code>.</p><p>How did I figure out the specific version of Windows the container is running? From the registry of course! The <code>SOFTWARE</code> registry hive contained information about installed software, including Windows itself, and was found at <code>Files/Windows/System32/config/SOFTWARE</code>.</p><p>Thankfully, there’s a great NuGet package called <a href=https://github.com/EricZimmerman/Registry>Registry</a> that let me easily load and parse the registry, but there are also packages for <a href=https://pkg.go.dev/golang.org/x/sys/windows/registry>Go</a>, <a href=https://github.com/bbqsrc/registry-rs>Rust</a>, and even <a href=https://github.com/ironSource/node-regedit>Node.js</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>using</span> <span style=color:#555>Registry</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#458;font-weight:700>var</span> registryHive = <span style=color:#000;font-weight:700>new</span> RegistryHive(<span style=color:#d14>&#34;/tmp/nanoserver/layer/Files/Windows/System32/config/SOFTWARE&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>registryHive.ParseHive();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#458;font-weight:700>var</span> currentVersion = registryHive.GetKey(<span style=color:#d14>@&#34;Microsoft\Windows NT\CurrentVersion&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#458;font-weight:700>var</span> fullVersion =
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#d14>$&#34;{currentVersion.GetValue(&#34;</span>CurrentMajorVersionNumber<span style=color:#d14>&#34;)}.{currentVersion.GetValue(&#34;</span>CurrentMinorVersionNumber<span style=color:#d14>&#34;)}.{currentVersion.GetValue(&#34;</span>CurrentBuildNumber<span style=color:#d14>&#34;)}.{currentVersion.GetValue(&#34;</span>UBR<span style=color:#d14>&#34;)}&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>Console.WriteLine(fullVersion);
</span></span></code></pre></div><p>Running this code, I got version <code>10.0.20348.1366</code> which was <a href=https://twitter.com/ChangeWindows/status/1602752823116333056>apparently released on 13th December 2022</a>.</p><h2 id=what-about-windows-updates>What about Windows updates?</h2><p>The version of Windows doesn’t tell the whole story. There are also updates that can be applied on top. You might have seen them referred to by their KB number, for example KB1234567. Information on what updates have been applied is also stored in the registry.</p><p>By extending my earlier code, I can find out what updates this container image has.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-csharp data-lang=csharp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#458;font-weight:700>var</span> packages = registryHive.GetKey(<span style=color:#d14>@&#34;Microsoft\Windows\CurrentVersion\Component Based Servicing\Packages&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#458;font-weight:700>var</span> updatePackageRegex = <span style=color:#000;font-weight:700>new</span> Regex(<span style=color:#d14>@&#34;^Package_\d+_for_(KB\d+)~\w{16}~\w+~~((?:\d+\.){3}\d+)$&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#458;font-weight:700>var</span> updates = <span style=color:#000;font-weight:700>new</span> Dictionary&lt;<span style=color:#458;font-weight:700>string</span>, <span style=color:#458;font-weight:700>string</span>&gt;();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000;font-weight:700>foreach</span> (<span style=color:#458;font-weight:700>var</span> packageKey <span style=color:#000;font-weight:700>in</span> packages.SubKeys)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    <span style=color:#000;font-weight:700>if</span> (!updatePackageRegex.IsMatch(packageKey.KeyName))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>continue</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#458;font-weight:700>var</span> currentState = packageKey.Values.Find(v =&gt; v.ValueName == <span style=color:#d14>&#34;CurrentState&#34;</span>)?.ValueData;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    <span style=color:#998;font-style:italic>// Installed</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#000;font-weight:700>if</span> (currentState == <span style=color:#d14>&#34;112&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#458;font-weight:700>var</span> groups = updatePackageRegex.Match(packageKey.KeyName).Groups;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        updates[groups[<span style=color:#099>1</span>].Value] = groups[<span style=color:#099>2</span>].Value;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#000;font-weight:700>foreach</span> (<span style=color:#458;font-weight:700>var</span> update <span style=color:#000;font-weight:700>in</span> updates)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    Console.WriteLine(<span style=color:#d14>$&#34;{update.Key}: {update.Value}&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>}
</span></span></code></pre></div><p>Running this gave me a single update: <code>KB5020373: 20348.1300.1.0</code>. Searching online for <a href=https://support.microsoft.com/en-gb/topic/november-8-2022-kb5020613-cumulative-update-for-net-framework-3-5-and-4-8-for-windows-10-version-20h2-windows-10-version-21h1-windows-10-version-21h2-and-windows-10-version-22h2-3880a78d-3b33-429a-93fc-eeb0c40b4ad4>KB5020373</a> led me to the documentation for the update. It’s the November 2022 security update for .NET Framework and has a fix for <a href=https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-41064>CVE-2022-41064</a>.</p><h2 id=done-now-what-if-we-scaled-this>Done! &mldr;Now what if we scaled this?</h2><p>It turns out it’s not that difficult to find out info about Windows container images. It took me a couple of hours to figure out, but that’s only because no one seems to have done this before. The actual code is only about 30 lines.</p><p>Windows containers are widely used for legacy applications, like .NET Framework applications, that haven’t been rewritten but could benefit from the cloud. All of the big three cloud providers offer managed Kubernetes services that support Windows nodes out of the box (yes, <a href=https://kubernetes.io/docs/concepts/windows/intro/#windows-os-version-support>Kubernetes supports Windows nodes</a>). There is clearly a demand for Windows containers, but there is a gap in the kind of container tooling that has sprung up for Linux containers.</p><p>Instead of allowing this gap to widen further, I think that container tool authors—especially SBOM tools and vulnerability scanners—should add support for Windows container images. These tools should then correlate the extracted information with the <a href=https://api.msrc.microsoft.com/cvrf/v2.0/swagger/index>Microsoft Security Research Center (MSRC) API</a>. MSRC publishes information every month on security updates. Comparing the Windows version from a container image with the fixed versions provided by the MSRC API, you could easily see your container image’s security vulnerabilities.</p><p>As my proof-of-concept has shown, it’s low-hanging fruit. A small addition that would have a big impact for the many forgotten developers and the applications they work on.</p></div><div class=pagination><span class=pagination-item>Newer</span>
<a class=pagination-item href=/page/2/>Older</a></div></div></div><script type=text/javascript>var disqus_shortname="jamiemagee";(function(){var e=document.createElement("script");e.async=!0,e.type="text/javascript",e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(e)})()</script></body></html>