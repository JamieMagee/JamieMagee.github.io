<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">


  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Setting up nginx reverse proxy with Let&#39;s Encrypt on unRAID &middot; Jamie Magee</title>


  <link rel="stylesheet" href="/css/poole.css">
  <link rel="stylesheet" href="/css/hyde.css">
  <link rel="stylesheet" href="/css/poole-overrides.css">
  <link rel="stylesheet" href="/css/hyde-overrides.css">
  <link rel="stylesheet" href="/css/hyde-x.css">
  <link rel="stylesheet" href="/css/highlight/github.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/jamie.css">


  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link href="/favicon.ico" rel="icon">






  <meta name="description" content="">
  <meta name="keywords" content="">


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-701081-9', 'auto');

	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body class="theme-base-0c">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <div class="sidebar-head">

        <img src="https://www.gravatar.com/avatar/5a37e2531db08529192d7d323e8cecd8?s=200"
             alt="gravatar" title="Jamie Magee">

      <h1><a href="/">Jamie Magee</a></h1>
      </div>
      <p class="lead">Programmer, Engineer, Problem Solver</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="/">Home</a></li>

      <li class="sidebar-nav-item "><a href="/about">About</a></li>

      <li class="sidebar-nav-item "><a href="/blog">Archive</a></li>

    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/JamieMagee"><i class="fa fa-github-square fa-3x"></i></a>


      <a href="https://www.linkedin.com/in/jamiemagee1/"><i class="fa fa-linkedin-square fa-3x"></i></a>


      <a href="http://twitter.com/Jamie_Magee"><i class="fa fa-twitter-square fa-3x"></i></a>


      </li>
    </ul>



    <p>
  &copy; 2019. <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>
</p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Setting up nginx reverse proxy with Let&rsquo;s Encrypt on unRAID</h1>
    <span class="post-date">Mar 28, 2016 &middot; 3 minute read &middot; <a href="/blog/setting-up-nginx-reverse-proxy-with-lets-encrypt-on-unraid/#disqus_thread">Comments</a>
    </span>


<p>Late last year I set about building a new NAS to replace my aging HP ProLiant MicroServer N36L (though that&rsquo;s a story for a different post). I decided to go with unRAID as my OS, over FreeNAS that I&rsquo;d been running previously, mostly due to the simpler configuration, ease of expanding an array, and support for Docker and KVM.</p>

<p>Docker support makes it a lot easier to run some of the web apps that I rely on like Plex, Sonarr, CouchPotato and more, but accessing them securely outside my network is a different story. On FreeNAS I ran an nginx reverse proxy in a BSD jail, secured using basic auth, and SSL certificates from <a href="https://www.startssl.com/">StartSSL</a>. Thankfully there is already a Docker image, <a href="https://hub.docker.com/r/jwilder/nginx-proxy/">nginx-proxy</a> by jwilder, which automatically configures nginx for you. As for SSL, <a href="https://letsencrypt.org/">Let&rsquo;s Encrypt</a> went into public beta in December, and recently issued their millionth certificate. There&rsquo;s also a Docker image which will automatically manage your certificates, and configure nginx for you - <a href="https://hub.docker.com/r/jrcs/letsencrypt-nginx-proxy-companion/">letsencrypt-nginx-proxy-companion</a> by jrcs.</p>

<h2 id="preparation">Preparation</h2>

<p>Firstly, you need to set up and configure Docker. There is a fantastic guide on how to configure Docker <a href="https://lime-technology.com/docker-guide/">here</a> on the Lime Technology website. Next, you need to install the <a href="https://lime-technology.com/forum/index.php?topic=40262.0">Community Applications</a> plugin. This allows us to install Docker containers directly from the Docker Hub.</p>

<p>In order to access everything from outside your LAN you&rsquo;ll need to forward ports 80 and 443 to ports 8008 and 443, respectively, on your unRAID host. In addition, you&rsquo;ll need to use some sort of Dynamic DNS service, though in my case I bought a domain name and use CloudFlare to handle my DNS.</p>

<h2 id="nginx">nginx</h2>

<p>From the Apps page on the unRAID web interface, search for <code>nginx-proxy</code> and click &lsquo;get more results from Docker Hub&rsquo;. Click &lsquo;add&rsquo; under the listing for <code>nginx-proxy</code> by jwilder. Set the following container settings, changing your &lsquo;host path&rsquo; to wherever you store Docker configuration files on your unRAID host</p>

<p><img src="/img/nginx-proxy-settings.png" alt="nginx-proxy settings" /></p>

<p>To add basic auth to any of the sites you&rsquo;ll need to make a file with the <code>VIRTUAL_HOST</code> of the site, available to nginx in <code>/etc/nginx/htpasswd</code>. For example, I added a file in <code>/mnt/user/docker/nginx/htpasswd/</code>. You can create htpasswd files using <code>apache2-utils</code>, or there are sites available which can create them.</p>

<h2 id="let-s-encrypt">Let&rsquo;s Encrypt</h2>

<p>From the Apps page again, search for <code>letsencrypt-nginx-proxy-companion</code>, click &lsquo;get more results from Docker Hub&rsquo;, and then click &lsquo;add&rsquo; under the listing for <code>letsencrypt-nginx-proxy-companion</code> by jrcs. Enter the following container settings, again changing your &lsquo;host path&rsquo; to wherever you store Docker configuration files on your unRAID host</p>

<p><img src="/img/lets-encrypt-settings.png" alt="lets encrypt settings" /></p>

<h2 id="putting-it-all-together">Putting it all together</h2>

<p>In order to configure nginx, you&rsquo;ll need to add four environment variables to the Docker containers you wish to put behind the reverse proxy. They are <code>VIRTUAL_HOST</code>, <code>VIRTUAL_PORT</code>, <code>LETSENCRYPT_HOST</code>, and <code>LETSENCRYPT_EMAIL</code>. <code>VIRTUAL_HOST</code> and <code>LETSENCRYPT_HOST</code> most likely need to be the same, and will be something like <code>subdomain.yourdomain.com</code>. <code>VIRTUAL_PORT</code> should be the port your Docker container exposes. For example, Sonarr uses port 8989 by default. <code>LETSENCRYPT_EMAIL</code> should be a valid email address that Let&rsquo;s Encrypt can use to email you about certificate expiries, etc.</p>

<p>Once <code>nginx-proxy</code>, <code>letsencrypt-nginx-proxy-companion</code>, and all your Docker containers are configured you should be able to access them all over SSL, with basic auth, from outside your LAN. You don&rsquo;t even have to worry about certificate renewals as it&rsquo;s all handled for you.</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "jamiemagee";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "jamiemagee";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script src="/js/cms.js"></script>
</body>
</html>
