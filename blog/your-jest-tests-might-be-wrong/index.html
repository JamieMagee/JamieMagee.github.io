<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><link href=http://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Your Jest tests might be wrong &#183; Jamie Magee</title><link rel=preload href=/css/poole.css as=style><link rel=preload href=/css/hyde.css as=style><link rel=preload href=/css/poole-overrides.css as=style><link rel=preload href=/css/hyde-overrides.css as=style><link rel=preload href=/css/hyde-x.css as=style><link rel=preload href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface" as=font><link rel=preload href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css as=style><link rel=stylesheet href=/css/poole.css><link rel=stylesheet href=/css/hyde.css><link rel=stylesheet href=/css/poole-overrides.css><link rel=stylesheet href=/css/hyde-overrides.css><link rel=stylesheet href=/css/hyde-x.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface"><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css><style>@font-face{font-family:berkeley mono;src:url(/fonts/BerkeleyMono-Regular.woff2)format('woff2')}</style><link rel=stylesheet href=/css/jamie.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link href=/favicon.ico rel=icon><meta name=description content><meta name=keywords content><meta property="og:title" content="Your Jest tests might be wrong"><meta property="og:description" content="Is your Jest test suite failing you? You might not be using the testing framework&rsquo;s full potential, especially when it comes to preventing state leakage between tests. The Jest settings clearMocks, resetMocks, restoreMocks, and resetModules are set to false by default. If you haven’t changed these defaults, your tests might be fragile, order-dependent, or just downright wrong. In this blog post, I’ll dig into what each setting does, and how you can fix your tests."><meta property="og:type" content="article"><meta property="og:url" content="/blog/your-jest-tests-might-be-wrong/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-05-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-05-04T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Your Jest tests might be wrong"><meta name=twitter:description content="Is your Jest test suite failing you? You might not be using the testing framework&rsquo;s full potential, especially when it comes to preventing state leakage between tests. The Jest settings clearMocks, resetMocks, restoreMocks, and resetModules are set to false by default. If you haven’t changed these defaults, your tests might be fragile, order-dependent, or just downright wrong. In this blog post, I’ll dig into what each setting does, and how you can fix your tests."></head><body class=theme-base-0c><div class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><div class=sidebar-head><h1><a href=/>Jamie Magee</a></h1></div><p class=lead>Programmer, Engineer, Problem Solver</p></div><ul class=sidebar-nav><li class=sidebar-nav-item><a href=/>Home</a></li><li class=sidebar-nav-item><a href=/about>About</a></li><li class=sidebar-nav-item><a href=/blog>Archive</a></li></ul><ul class=sidebar-nav><li class=sidebar-nav-item><a href=https://github.com/JamieMagee><i class="fa fa-github-square fa-3x"></i></a>
<a href=https://www.linkedin.com/in/jamiemagee1/><i class="fa fa-linkedin-square fa-3x"></i></a>
<a href=http://twitter.com/Jamie_Magee><i class="fa fa-twitter-square fa-3x"></i></a></li></ul><p>&copy; 2023. <a href=https://creativecommons.org/licenses/by-nc/4.0/>CC BY-NC 4.0</a></p></div></div><div class="content container"><div class=post><h1 class=post-title>Your Jest tests might be wrong</h1><span class=post-date>May 4, 2023 &#183; 7 minute read &#183; <a href=/blog/your-jest-tests-might-be-wrong/#disqus_thread>Comments</a></span><p>Is your Jest test suite failing you? You might not be using the testing framework&rsquo;s full potential, especially when it comes to preventing state leakage between tests. The Jest settings <a href=https://jestjs.io/docs/configuration#clearmocks-boolean><code>clearMocks</code></a>, <a href=https://jestjs.io/docs/configuration#resetmocks-boolean><code>resetMocks</code></a>, <a href=https://jestjs.io/docs/configuration#restoremocks-boolean><code>restoreMocks</code></a>, and <a href=https://jestjs.io/docs/configuration#resetmodules-boolean><code>resetModules</code></a> are set to <code>false</code> by default. If you haven’t changed these defaults, your tests might be fragile, order-dependent, or just downright wrong. In this blog post, I’ll dig into what each setting does, and how you can fix your tests.</p><h2 id=clearmocks><code>clearMocks</code></h2><p>First up is <code>clearMocks</code>:</p><blockquote><p>Automatically clear mock calls, instances, contexts and results before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestclearallmocks><code>jest.clearAllMocks()</code></a> before each test. This does not remove any mock implementation that may have been provided.</p></blockquote><p>Every Jest mock has some context associated with it. It’s how you’re able to call functions like <code>mockReturnValueOnce</code> instead of only <code>mockReturnValue</code>. But if <code>clearMocks</code> is false by default, then that context can be carried between tests.</p><p>Take this example function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>export</span> <span style=color:#000;font-weight:700>function</span> randomNumber() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>Math</span>.random();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>}
</span></span></code></pre></div><p>And this simple test for it:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>jest.mock(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>});
</span></span></code></pre></div><p>The test passes and works as expected. However, if we add another test to our test suite:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>jest.mock(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    it(<span style=color:#d14>&#39;should return same number&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>});
</span></span></code></pre></div><p>Our second test fails with the error:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#000;font-weight:700>(</span>jest.fn<span style=color:#000;font-weight:700>())</span>.toBeCalledTimes<span style=color:#000;font-weight:700>(</span>expected<span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Expected number of calls: <span style=color:#099>2</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Received number of calls: <span style=color:#099>3</span>
</span></span></code></pre></div><p>And even worse, if we change the order of our tests:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>jest.mock(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;should return same number&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>});
</span></span></code></pre></div><p>We get the same error as before, but this time for <code>should return 42</code> instead of <code>should return same number</code>.</p><p>Enabling <code>clearMocks</code> in your Jest configuration ensures that every mock’s context is reset between tests. You can achieve the same result by adding <code>jest.clearAllMocks()</code> to your <code>beforeEach()</code> functions. But this isn’t a great idea as it means you have to remember to add it to each test file to make your tests safe, instead of using <code>clearMocks</code> to make them all safe by default.</p><h2 id=resetmocks><code>resetMocks</code></h2><p>Next up is <code>resetMocks</code>:</p><blockquote><p>Automatically reset mock state before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestresetallmocks><code>jest.resetAllMocks()</code></a> before each test. This will lead to any mocks having their fake implementations removed but does not restore their initial implementation.</p></blockquote><p><code>resetMocks</code> takes <code>clearMocks</code> a step further, by clearing the implementation of any mocks. However, you need to use it in addition to <code>clearMocks</code>.</p><p>Going back to my first example again, I’m going to move the mock setup inside the first test case <code>randomNumber.mockReturnValue(42);</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        randomNumber.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    it(<span style=color:#d14>&#39;should return 42 twice&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        expect(randomNumber).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>});
</span></span></code></pre></div><p>Logically, you might expect this to fail, but it passes! Jest mocks are global to the file they’re in. It doesn’t matter what <code>describe</code>, <code>it</code>, or <code>test</code> scope you use. And if I change the order of tests again, they fail. This makes it very easy to write tests that leak state and are order-dependent.</p><p>Enabling <code>resetMocks</code> in your Jest context ensures that every mock implementation is reset between tests. Like before, you can also add <code>jest.resetAllMocks()</code> to <code>beforeEach()</code> in every test file. But it’s a much better idea to make your tests safe by default instead of having to opt-in to safe tests.</p><h2 id=restoremocks><strong><code>restoreMocks</code></strong></h2><p>Next is <code>restoreMocks</code>:</p><blockquote><p>Automatically restore mock state and implementation before every test. Equivalent to calling <a href=https://jestjs.io/docs/jest-object#jestrestoreallmocks><code>jest.restoreAllMocks()</code></a> before each test. This will lead to any mocks having their fake implementations removed and restores their initial implementation.</p></blockquote><p><code>restoreMocks</code> takes test isolation and safety to the next level.</p><p>Let me rewrite my example a little bit, so instead of mocking the function directly, I’m mocking <code>Math.random()</code> instead.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>const</span> { randomNumber } <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>const</span> spy <span style=color:#000;font-weight:700>=</span> jest.spyOn(<span style=color:#0086b3>Math</span>, <span style=color:#d14>&#39;random&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        spy.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    it(<span style=color:#d14>&#39;should return 42 twice&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        spy.mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>});
</span></span></code></pre></div><p>With <code>clearMocks</code> and <code>resetMocks</code> enabled, and <code>restoreMocks</code> disabled, my tests pass. But if I enable <code>restoreMocks</code> both tests fail with an error message like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#000;font-weight:700>(</span>received<span style=color:#000;font-weight:700>)</span>.toBe<span style=color:#000;font-weight:700>(</span>expected<span style=color:#000;font-weight:700>)</span> // Object.is equality
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Expected: <span style=color:#099>42</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>Received: 0.503533695686772
</span></span></code></pre></div><p><code>restoreMocks</code> has restored the original implementation of <code>Math.random()</code> before each test, so now I’m getting an actual random number instead of my mocked return value of <code>42</code>. This forces me to be explicit about not only the mocked return values I’m expecting, but the mocks themselves.</p><p>To fix my tests I can set up my Jest mocks in each individual test.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    it(<span style=color:#d14>&#39;should return 42&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        <span style=color:#000;font-weight:700>const</span> spy <span style=color:#000;font-weight:700>=</span> jest.spyOn(<span style=color:#0086b3>Math</span>, <span style=color:#d14>&#39;random&#39;</span>).mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        <span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        expect(random).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>1</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    it(<span style=color:#d14>&#39;should return 42 twice&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        <span style=color:#000;font-weight:700>const</span> spy <span style=color:#000;font-weight:700>=</span> jest.spyOn(<span style=color:#0086b3>Math</span>, <span style=color:#d14>&#39;random&#39;</span>).mockReturnValue(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#000;font-weight:700>const</span> random1 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        <span style=color:#000;font-weight:700>const</span> random2 <span style=color:#000;font-weight:700>=</span> randomNumber();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>        expect(random1).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>        expect(random2).toBe(<span style=color:#099>42</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        expect(spy).toBeCalledTimes(<span style=color:#099>2</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>});
</span></span></code></pre></div><h2 id=resetmodules><code>resetModules</code></h2><p>Finally, we have <code>resetModules</code>:</p><blockquote><p>By default, each test file gets its own independent module registry. Enabling <code>resetModules</code> goes a step further and resets the module registry before running each individual test. This is useful to isolate modules for every test so that the local module state doesn&rsquo;t conflict between tests. This can be done programmatically using <a href=https://jestjs.io/docs/jest-object#jestresetmodules><code>jest.resetModules()</code></a>.</p></blockquote><p>Again, this builds on top of <code>clearMocks</code>, <code>resetMocks</code>, and <code>restoreMocks</code>. I don’t think this level of isolation is required for most tests, but I’m a completionist.</p><p>Let’s take my example from above and expand it to include some initialization that needs to happen before I can call <code>randomNumber</code>. Maybe I need to make sure there’s enough entropy to generate random numbers? My module might look something like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>let</span> isInitialized <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;font-weight:700>export</span> <span style=color:#000;font-weight:700>function</span> initialize() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    isInitialized <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000;font-weight:700>export</span> <span style=color:#000;font-weight:700>function</span> randomNumber() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#000;font-weight:700>if</span> (<span style=color:#000;font-weight:700>!</span>isInitialized) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        <span style=color:#000;font-weight:700>throw</span> <span style=color:#000;font-weight:700>new</span> <span style=color:#0086b3>Error</span>();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#0086b3>Math</span>.random();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>}
</span></span></code></pre></div><p>I also want to write some tests to make sure that this works as expected:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-ts data-lang=ts><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>const</span> random <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>require</span>(<span style=color:#d14>&#39;.&#39;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>describe(<span style=color:#d14>&#39;tests&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    it(<span style=color:#d14>&#39;does not throw when initialized&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>        expect(() <span style=color:#000;font-weight:700>=&gt;</span> random.initialize()).not.toThrow();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    it(<span style=color:#d14>&#39;throws when not initialized&#39;</span>, () <span style=color:#000;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        expect(() <span style=color:#000;font-weight:700>=&gt;</span> random.randomNumber()).toThrow();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    });
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>});
</span></span></code></pre></div><p><code>initialize</code> shouldn’t throw an error, but <code>randomNumber</code> should throw an error if <code>initialize</code> isn’t called first. Great! Except it doesn’t work. Instead I get:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>Error: expect<span style=color:#000;font-weight:700>(</span>received<span style=color:#000;font-weight:700>)</span>.toThrow<span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>Received <span style=color:#000;font-weight:700>function</span> did not throw
</span></span></code></pre></div><p>That’s because without enabling <code>resetModules</code>, the module is shared between all tests in the file. So when I called <code>random.initialize()</code> in my first test, <code>isInitialized</code> is still true for my second test. But once again, if I were to switch the order of my tests in the file, they would both pass. So my tests are order-dependent again!</p><p>Enabling <code>resetModules</code> will give each test in the file a fresh version of the module for each test. Though, this might actually be a case where you want to use <code>jest.resetAllModules()</code> in your <code>beforeEach()</code> instead of enabling it globally. This kind of isolation isn’t required for every test. And if you’re using <code>import</code> instead of <code>require</code>, the syntax can get very awkward very quickly if you’re trying to avoid an <code>'import' and 'export' may only appear at the top level</code> error.</p><h2 id=tldr-reset-all-of-the-things>TL;DR reset all of the things</h2><p>By default, Jest tests are only isolated at the file level. If you really want to make sure your tests are safe and isolated, add this to your Jest config:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-js data-lang=js><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  clearMocks<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  resetMocks<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  restoreMocks<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  resetModules<span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>true</span> <span style=color:#998;font-style:italic>// It depends
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#998;font-style:italic></span>}
</span></span></code></pre></div><p>There is <a href=https://github.com/facebook/jest/issues/10242>a suggestion</a> to make this part of the default configuration. But until then, you’ll have to do it yourself.</p></div><div id=disqus_thread></div></div><script type=text/javascript>var disqus_shortname="jamiemagee";(function(){var e=document.createElement("script");e.async=!0,e.type="text/javascript",e.src="//"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(e)})()</script><script type=text/javascript>var disqus_shortname="jamiemagee";(function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></body></html>